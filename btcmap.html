<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Business Map</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    
    <!-- Make sure Leaflet JS is loaded after CSS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .btcmap-header {
            background-color: #f7931a;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
        }
        .btcmap-header h1 {
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 700;
            margin: 0;
        }
        .btcmap-header p {
            font-family: 'Roboto Condensed', sans-serif;
            margin-bottom: 0;
            opacity: 0.9;
        }
        .btcmap-bitcoin-icon {
            height: 48px;
            margin-right: 15px;
            vertical-align: middle;
        }
        #btcmap-map {
            height: 500px;
            width: 100%;
            margin-bottom: 20px;
        }
        .btcmap-filter-section {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            padding: 15px;
        }
        .btcmap-business-list {
            max-height: 600px;
            overflow-y: auto;
        }
        .btcmap-business-item {
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        .btcmap-business-item:hover {
            background-color: #f8f9fa;
            border-left: 4px solid #f7931a;
        }
        .btcmap-business-item.selected {
            background-color: #fff8f0;
            border-left: 4px solid #f7931a;
        }
        .btcmap-loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        .btcmap-loading-spinner .spinner-border {
            width: 3rem;
            height: 3rem;
            color: #f7931a;
        }
        .btcmap-marker-cluster {
            background-color: rgba(247, 147, 26, 0.6);
            border-radius: 50%;
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btcmap-marker-cluster div {
            background-color: rgba(247, 147, 26, 0.8);
            width: 80%;
            height: 80%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btcmap-custom-marker {
            background-color: #f7931a;
            border-radius: 50%;
            color: white;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }
        .btcmap-marker-selected {
            background-color: #e74c3c;
            transform: scale(1.2);
            z-index: 1000 !important;
        }
        .btcmap-payment-badge {
            display: inline-block;
            margin-right: 8px;
            margin-bottom: 8px;
            padding: 5px 10px;
            border-radius: 4px;
        }
        .btcmap-onchain-badge {
            background-color: #f7931a;
            color: white;
        }
        .btcmap-lightning-badge {
            background-color: #792ee5;
            color: white;
        }
        .btcmap-coinos-badge {
            background-color: #2d3748;
            color: white;
        }
        .btcmap-business-detail {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .btcmap-social-links {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .btcmap-social-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #f1f3f5;
            color: #495057;
            font-size: 1rem;
            transition: all 0.2s ease;
        }
        .btcmap-social-link:hover {
            background-color: #f7931a;
            color: white;
            transform: translateY(-2px);
        }
        /* List view styles */
        .btcmap-list-view-table {
            margin-bottom: 0;
        }

        .btcmap-list-view-table th {
            background-color: #f8f9fa;
            cursor: pointer;
        }

        .btcmap-list-view-table tr {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btcmap-list-view-table tr:hover {
            background-color: #f8f9fa;
        }

        .btcmap-list-view-table tr.selected {
            background-color: #fff8f0;
        }

        .btcmap-sortable {
            cursor: pointer;
            user-select: none;
        }

        .btcmap-sortable:hover {
            background-color: #f0f0f0;
        }

        .btcmap-sortable i {
            opacity: 0.3;
            margin-left: 5px;
        }

        .btcmap-sortable.sort-asc i {
            opacity: 1;
            transform: rotate(180deg);
        }

        .btcmap-sortable.sort-desc i {
            opacity: 1;
        }

        .btcmap-distance-column {
            min-width: 100px;
        }

        .btcmap-distance-badge {
            display: inline-block;
            background-color: #f0f7ff;
            color: #0066ff;
            padding: 3px 6px;
            border-radius: 6px;
            font-size: 0.8em;
            white-space: nowrap;
            font-weight: 500;
        }

        .btcmap-distance-badge i {
            color: #0066ff;
            margin-right: 4px;
        }

        .btcmap-distance-badge .unit {
            opacity: 1;
            font-size: 0.9em;
        }

        .btcmap-distance-badge .separator {
            margin: 0 4px;
            opacity: 0.7;
        }

        /* Map container styles */
        .btcmap-map-container {
            transition: all 0.3s ease;
        }

        /* Adjust layout when detail is shown */
        .btcmap-detail-visible .btcmap-map-container {
            margin-left: 33.333%;
            width: 66.666%;
        }

        .btcmap-detail-visible .btcmap-business-detail {
            position: fixed;
            top: 100px;
            left: 20px;
            width: calc(33.333% - 40px);
            max-height: calc(100vh - 120px);
            overflow-y: auto;
            z-index: 1000;
        }

        @media (max-width: 991px) {
            .btcmap-detail-visible .btcmap-map-container {
                margin-left: 0;
                width: 100%;
            }

            .btcmap-detail-visible .btcmap-business-detail {
                position: static;
                width: 100%;
                max-height: none;
            }
        }

        /* View on Map button styles */
        .btcmap-view-on-map-btn {
            background-color: #f7931a;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            transition: background-color 0.2s ease;
        }

        .btcmap-view-on-map-btn:hover {
            background-color: #e07d16;
        }

        .btcmap-view-on-map-btn i {
            font-size: 1.1em;
        }

        /* Disclaimer styles */
        .btcmap-data-source-disclaimer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
            color: #6c757d;
            font-size: 0.875rem;
            font-style: italic;
        }

        .btcmap-data-source-disclaimer a {
            color: #f7931a;
            text-decoration: none;
        }

        .btcmap-data-source-disclaimer a:hover {
            text-decoration: underline;
        }

        /* Back to top button styles */
        .btcmap-back-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #f7931a;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .btcmap-back-to-top:hover {
            background-color: #e07d16;
        }

        .btcmap-back-to-top.visible {
            opacity: 1;
        }

        /* Loading indicator styles */
        .btcmap-loading-more {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .btcmap-loading-more .spinner-border {
            width: 1.5rem;
            height: 1.5rem;
            color: #f7931a;
        }

        /* Pagination info styles */
        .btcmap-pagination-info {
            text-align: right;
            color: #6c757d;
            font-size: 0.875rem;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="btcmap-header">
        <div class="container">
            <div class="d-flex align-items-center">
                <img src="images/icons/btcLogo.svg" alt="Bitcoin Logo" class="btcmap-bitcoin-icon">
                <div>
                    <h1>Bitcoin Business Map</h1>
                    <p>Find businesses that accept Bitcoin payments worldwide</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Filter Section -->
        <div class="btcmap-filter-section mb-4">
            <div class="row">
                <div class="col-md-4 mb-2">
                    <label for="btcmap-searchInput" class="form-label">Search</label>
                    <input type="text" class="form-control" id="btcmap-searchInput" placeholder="Search businesses...">
                </div>
                <div class="col-md-8 mb-2">
                    <label class="form-label">My Location:</label>
                    <div class="d-flex gap-2">
                        <select id="btcmap-locationDropdown" class="form-select flex-grow-1">
                            <option value="">Select a city</option>
                            <optgroup label="North America">
                                <option value="37.7749,-122.4194">San Francisco</option>
                                <option value="40.7128,-74.0060">New York City</option>
                                <option value="41.8781,-87.6298">Chicago</option>
                                <option value="34.0522,-118.2437">Los Angeles</option>
                                <option value="29.7604,-95.3698">Houston</option>
                                <option value="43.6532,-79.3832">Toronto</option>
                                <option value="19.4326,-99.1332">Mexico City</option>
                                <option value="45.5017,-73.5673">Montreal</option>
                                <option value="25.7617,-80.1918">Miami</option>
                                <option value="49.2827,-123.1207">Vancouver</option>
                            </optgroup>
                            <optgroup label="Europe">
                                <option value="51.5074,-0.1278">London</option>
                                <option value="48.8566,2.3522">Paris</option>
                                <option value="52.5200,13.4050">Berlin</option>
                                <option value="41.9028,12.4964">Rome</option>
                                <option value="52.3676,4.9041">Amsterdam</option>
                                <option value="59.3293,18.0686">Stockholm</option>
                                <option value="41.3851,2.1734">Barcelona</option>
                                <option value="55.6761,12.5683">Copenhagen</option>
                                <option value="53.3498,-6.2603">Dublin</option>
                                <option value="48.2082,16.3738">Vienna</option>
                            </optgroup>
                            <optgroup label="Asia">
                                <option value="35.6762,139.6503">Tokyo</option>
                                <option value="22.3193,114.1694">Hong Kong</option>
                                <option value="1.3521,103.8198">Singapore</option>
                                <option value="25.2048,55.2708">Dubai</option>
                                <option value="13.7563,100.5018">Bangkok</option>
                                <option value="37.5665,126.9780">Seoul</option>
                                <option value="31.2304,121.4737">Shanghai</option>
                                <option value="19.0760,72.8777">Mumbai</option>
                                <option value="28.6139,77.2090">New Delhi</option>
                                <option value="3.1390,101.6869">Kuala Lumpur</option>
                            </optgroup>
                            <optgroup label="Australia/Oceania">
                                <option value="-33.8688,151.2093">Sydney</option>
                                <option value="-37.8136,144.9631">Melbourne</option>
                                <option value="-36.8485,174.7633">Auckland</option>
                                <option value="-41.2865,174.7762">Wellington</option>
                                <option value="-27.4698,153.0251">Brisbane</option>
                            </optgroup>
                            <optgroup label="South America">
                                <option value="-34.6037,-58.3816">Buenos Aires</option>
                                <option value="-23.5505,-46.6333">SÃ£o Paulo</option>
                                <option value="-33.4489,-70.6693">Santiago</option>
                                <option value="-12.0464,-77.0428">Lima</option>
                                <option value="-0.1807,-78.4678">Quito</option>
                            </optgroup>
                            <optgroup label="Africa">
                                <option value="-33.9249,18.4241">Cape Town</option>
                                <option value="30.0444,31.2357">Cairo</option>
                                <option value="-1.2921,36.8219">Nairobi</option>
                                <option value="6.5244,3.3792">Lagos</option>
                                <option value="33.9716,-6.8498">Rabat</option>
                            </optgroup>
                        </select>
                        <button class="btn btn-outline-primary d-flex align-items-center gap-2" id="btcmap-useMyLocation">
                            <i class="bi bi-geo-alt"></i>
                            Use My Location
                        </button>
                    </div>
                    <div id="btcmap-locationStatus" class="text-muted mt-1" style="font-size: 0.875rem;">
                        <!-- Location status will be shown here -->
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-4 mb-2">
                    <label for="btcmap-regionSelect" class="form-label">Region</label>
                    <select class="form-select" id="btcmap-regionSelect">
                        <option value="worldwide">Worldwide</option>
                        <option value="north-america" selected>North America</option>
                        <option value="south-america">South America</option>
                        <option value="europe">Europe</option>
                        <option value="asia">Asia</option>
                        <option value="africa">Africa</option>
                        <option value="oceania">Australia/Oceania</option>
                    </select>
                </div>
                <div class="col-md-4 mb-2">
                    <label for="btcmap-categorySelect" class="form-label">Category</label>
                    <select class="form-select" id="btcmap-categorySelect">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="col-12">
                    <button class="btn btn-outline-secondary" type="button" id="btcmap-clearFilters">
                        <i class="bi bi-x-circle"></i> Clear Filters
                    </button>
                    <div id="btcmap-filterStatus" class="mt-2"></div>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div class="btcmap-loading-spinner" id="btcmap-loadingSpinner">
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="mt-3" id="btcmap-loadingMessage">
                    Loading Bitcoin businesses...
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div id="btcmap-mainContent" style="display: none;">
            <!-- Business Detail -->
            <div class="btcmap-business-detail" id="btcmap-businessDetail" style="display: none;">
                <button type="button" class="btn-close float-end" id="btcmap-closeDetail"></button>
                <h3 id="btcmap-detailName"></h3>
                <div id="btcmap-detailCategories" class="mb-3"></div>
                <button class="btcmap-view-on-map-btn" id="btcmap-viewOnMapBtn">
                    <i class="bi bi-geo-alt-fill"></i>
                    View on Map
                </button>
                <div class="mb-3">
                    <strong>Location:</strong>
                    <div id="btcmap-detailLocation"></div>
                </div>
                <div class="mb-3">
                    <strong>Payment Methods:</strong>
                    <div id="btcmap-detailPaymentMethods"></div>
                </div>
                <div class="mb-3">
                    <strong>Website:</strong>
                    <div id="btcmap-detailWebsite"></div>
                </div>
                <div class="mb-3">
                    <strong>Social Media:</strong>
                    <div id="btcmap-detailSocial" class="btcmap-social-links"></div>
                </div>
                <div class="btcmap-data-source-disclaimer">
                    Data sourced from <a href="https://btcmap.org" target="_blank" rel="noopener noreferrer">BTCMap.org</a>. Information may not be up to date - please verify details with the business directly.
                </div>
            </div>

            <!-- Map Section -->
            <div class="btcmap-map-container">
                <div class="row mb-4">
                    <div class="col-12">
                        <div id="btcmap-map"></div>
                    </div>
                </div>
            </div>

            <!-- Business List Section -->
            <div class="row">
                <div class="col-12">
                    <div class="btcmap-pagination-info" id="btcmap-paginationInfo"></div>
                    <div class="table-responsive">
                        <table class="table table-hover btcmap-list-view-table">
                            <thead>
                                <tr>
                                    <th class="btcmap-sortable" data-sort="name">
                                        Business Name <i class="bi bi-arrow-down-up"></i>
                                    </th>
                                    <th>Categories</th>
                                    <th class="btcmap-sortable" data-sort="location">
                                        Location <i class="bi bi-arrow-down-up"></i>
                                    </th>
                                    <th class="btcmap-sortable btcmap-distance-column" data-sort="distance">
                                        Distance <i class="bi bi-arrow-down-up"></i>
                                    </th>
                                    <th>Website/Social</th>
                                </tr>
                            </thead>
                            <tbody id="btcmap-businessList">
                                <!-- Business list items will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="btcmap-loading-more" id="btcmap-loadingMore">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading more...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Back to top button -->
            <button class="btcmap-back-to-top" id="btcmap-backToTop" title="Back to top">
                <i class="bi bi-arrow-up"></i>
            </button>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Region boundaries
        const btcmapRegionBounds = {
            'worldwide': {
                center: [20, 0],
                zoom: 2,
                bounds: [[-60, -180], [85, 180]]
            },
            'north-america': {
                center: [39.8283, -98.5795],
                zoom: 4,
                bounds: [[14.0101, -168.1248], [71.3388, -52.3328]]
            },
            'south-america': {
                center: [-8.7832, -55.4915],
                zoom: 4,
                bounds: [[-55.9808, -81.3582], [12.4462, -34.7949]]
            },
            'europe': {
                center: [54.5260, 15.2551],
                zoom: 4,
                bounds: [[34.5428, -24.5673], [71.1854, 69.0601]]
            },
            'asia': {
                center: [34.0479, 100.6197],
                zoom: 3,
                bounds: [[-10.3600, 25.6506], [63.8605, 149.4126]]
            },
            'africa': {
                center: [8.7832, 34.5085],
                zoom: 3,
                bounds: [[-35.1364, -17.5866], [37.5681, 51.4128]]
            },
            'oceania': {
                center: [-25.2744, 133.7751],
                zoom: 4,
                bounds: [[-47.1853, 96.8181], [5.9336, 175.2919]]
            }
        };

        // Global variables
        let btcmapMap;
        let btcmapMarkers = [];
        let btcmapBusinesses = [];
        let btcmapFilteredBusinesses = [];
        let btcmapSelectedBusinessId = null;
        let btcmapUserLocation = null;

        // Cache management functions
        const BTCMAP_CACHE_VERSION = '1';
        const BTCMAP_CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 hours in milliseconds

        function btcmapGetCacheKey(region) {
            return `btcmap_data_${region}_${BTCMAP_CACHE_VERSION}`;
        }

        function btcmapGetTimestampKey(region) {
            return `btcmap_timestamp_${region}_${BTCMAP_CACHE_VERSION}`;
        }

        function btcmapSaveToCache(region, data) {
            try {
                const timestamp = new Date().getTime();
                localStorage.setItem(btcmapGetCacheKey(region), JSON.stringify(data));
                localStorage.setItem(btcmapGetTimestampKey(region), timestamp.toString());
                console.log(`Cached ${data.length} businesses for ${region}`);
            } catch (error) {
                console.error('Error saving to cache:', error);
                // If localStorage is full, clear it and try again
                if (error.name === 'QuotaExceededError') {
                    localStorage.clear();
                    try {
                        localStorage.setItem(btcmapGetCacheKey(region), JSON.stringify(data));
                        localStorage.setItem(btcmapGetTimestampKey(region), new Date().getTime().toString());
                    } catch (retryError) {
                        console.error('Error saving to cache after clearing:', retryError);
                    }
                }
            }
        }

        function btcmapGetFromCache(region) {
            try {
                const timestamp = localStorage.getItem(btcmapGetTimestampKey(region));
                if (!timestamp) return null;

                const age = new Date().getTime() - parseInt(timestamp);
                if (age > BTCMAP_CACHE_DURATION) {
                    // Cache is too old, clear it
                    localStorage.removeItem(btcmapGetCacheKey(region));
                    localStorage.removeItem(btcmapGetTimestampKey(region));
                    return null;
                }

                const cachedData = localStorage.getItem(btcmapGetCacheKey(region));
                if (!cachedData) return null;

                const data = JSON.parse(cachedData);
                console.log(`Retrieved ${data.length} businesses from cache for ${region}`);
                return data;
            } catch (error) {
                console.error('Error reading from cache:', error);
                return null;
            }
        }

        // Initialize the map
        function btcmapInitMap() {
            // Make sure the map container is visible
            document.getElementById('btcmap-mainContent').style.display = 'block';
            
            // Initialize map with specific options
            btcmapMap = L.map('btcmap-map', {
                minZoom: 2,
                maxBounds: [[-90, -180], [90, 180]],
                maxBoundsViscosity: 1.0,
                worldCopyJump: true
            });

            // Add the tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(btcmapMap);

            // Set initial view
            const region = document.getElementById('btcmap-regionSelect').value;
            const regionConfig = btcmapRegionBounds[region];
            btcmapMap.setView(regionConfig.center, regionConfig.zoom);
            
            // Force a resize after a short delay to ensure proper rendering
            setTimeout(() => {
                btcmapMap.invalidateSize();
            }, 100);
        }

        // Fetch businesses from Overpass API
        async function btcmapFetchBusinesses(region) {
            // Update loading message
            const regionName = region.split('-').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');

            // Check cache first
            const cachedData = btcmapGetFromCache(region);
            if (cachedData) {
                document.getElementById('btcmap-loadingMessage').textContent = 
                    `Loading cached data for ${regionName}...`;
                return cachedData;
            }

            document.getElementById('btcmap-loadingMessage').textContent = 
                `Querying OpenStreetMap for Bitcoin businesses in ${regionName}...`;

            const bounds = btcmapRegionBounds[region].bounds;
            const query = `
                [out:json][timeout:25];
                (
                    // Businesses that accept Bitcoin payments
                    node["payment:bitcoin"="yes"](${bounds[0][0]},${bounds[0][1]},${bounds[1][0]},${bounds[1][1]});
                    way["payment:bitcoin"="yes"](${bounds[0][0]},${bounds[0][1]},${bounds[1][0]},${bounds[1][1]});
                    relation["payment:bitcoin"="yes"](${bounds[0][0]},${bounds[0][1]},${bounds[1][0]},${bounds[1][1]});
                    
                    // Businesses that use XBT currency
                    node["currency:XBT"="yes"](${bounds[0][0]},${bounds[0][1]},${bounds[1][0]},${bounds[1][1]});
                    way["currency:XBT"="yes"](${bounds[0][0]},${bounds[0][1]},${bounds[1][0]},${bounds[1][1]});
                    relation["currency:XBT"="yes"](${bounds[0][0]},${bounds[0][1]},${bounds[1][0]},${bounds[1][1]});

                    // Businesses that use CoinOS
                    node["payment:coinos"="yes"](${bounds[0][0]},${bounds[0][1]},${bounds[1][0]},${bounds[1][1]});
                    way["payment:coinos"="yes"](${bounds[0][0]},${bounds[0][1]},${bounds[1][0]},${bounds[1][1]});
                    relation["payment:coinos"="yes"](${bounds[0][0]},${bounds[0][1]},${bounds[1][0]},${bounds[1][1]});
                );
                out body;
                >;
                out skel qt;
            `;

            try {
                document.getElementById('btcmap-loadingMessage').textContent = 
                    `Fetching data from OpenStreetMap for ${regionName}...`;

                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: query
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                document.getElementById('btcmap-loadingMessage').textContent = 
                    `Processing business data for ${regionName}...`;

                const data = await response.json();
                const processedData = btcmapProcessOverpassData(data.elements);
                
                // Save to cache
                btcmapSaveToCache(region, processedData);
                
                return processedData;
            } catch (error) {
                document.getElementById('btcmap-loadingMessage').textContent = 
                    `Error loading data for ${regionName}`;
                console.error('Error fetching data:', error);
                throw error;
            }
        }

        // Process Overpass API data
        function btcmapProcessOverpassData(elements) {
            return elements
                .filter(element => element.tags)
                .map(element => {
                    const tags = element.tags;
                    return {
                        id: element.id.toString(),
                        name: tags.name || 'Unnamed Business',
                        categories: [
                            tags.amenity,
                            tags.shop,
                            tags.tourism,
                            tags.leisure
                        ].filter(Boolean),
                        coordinates: {
                            lat: element.lat || (element.center && element.center.lat),
                            lng: element.lon || (element.center && element.center.lon)
                        },
                        address: {
                            street: tags['addr:street'],
                            housenumber: tags['addr:housenumber'],
                            city: tags['addr:city'],
                            state: tags['addr:state'],
                            country: tags['addr:country']
                        },
                        website: tags.website || tags['contact:website'],
                        paymentMethods: {
                            onchain: tags['payment:bitcoin'] === 'yes' || tags['currency:XBT'] === 'yes',
                            lightning: tags['payment:lightning'] === 'yes',
                            coinos: tags['payment:coinos'] === 'yes'
                        },
                        socialMedia: {
                            twitter: tags['contact:twitter'],
                            instagram: tags['contact:instagram'],
                            facebook: tags['contact:facebook'],
                            telegram: tags['contact:telegram']
                        }
                    };
                })
                .filter(business => business.coordinates.lat && business.coordinates.lng);
        }

        // Add markers to map
        function btcmapAddMarkersToMap(businesses) {
            // Clear existing markers
            btcmapMarkers.forEach(marker => marker.remove());
            btcmapMarkers = [];

            businesses.forEach(business => {
                const marker = L.marker([business.coordinates.lat, business.coordinates.lng], {
                    icon: L.divIcon({
                        className: 'btcmap-custom-marker',
                        html: business.name.charAt(0).toUpperCase(),
                        iconSize: [32, 32]
                    })
                });

                marker.bindPopup(btcmapCreatePopupContent(business));
                marker.on('click', () => btcmapShowBusinessDetail(business.id));
                marker.addTo(btcmapMap);
                btcmapMarkers.push(marker);
            });

            // Fit map to markers if we have any
            if (btcmapMarkers.length > 0) {
                const group = L.featureGroup(btcmapMarkers);
                btcmapMap.fitBounds(group.getBounds());
            }
        }

        // Create popup content
        function btcmapCreatePopupContent(business) {
            return `
                <div class="popup-content">
                    <h5>${business.name}</h5>
                    ${business.categories.length ? `
                        <div class="categories mb-2">
                            ${business.categories.map(cat => `
                                <span class="badge bg-secondary me-1">${cat}</span>
                            `).join('')}
                        </div>
                    ` : ''}
                    <button class="btn btn-sm btn-primary" onclick="btcmapShowBusinessDetail('${business.id}')">
                        View Details
                    </button>
                </div>
            `;
        }

        // Update business list function to include distance
        function btcmapUpdateBusinessList(businesses) {
            const listContainer = document.getElementById('btcmap-businessList');
            listContainer.innerHTML = '';

            // Check if we're in location mode
            const hasLocation = btcmapUserLocation !== null;

            // Show/hide distance column based on location availability
            document.querySelectorAll('.btcmap-distance-column').forEach(el => {
                el.style.display = hasLocation ? 'table-cell' : 'none';
            });

            businesses.forEach(business => {
                const row = document.createElement('tr');
                row.className = business.id === btcmapSelectedBusinessId ? 'selected' : '';
                row.onclick = () => btcmapShowBusinessDetail(business.id);

                // Get location display text
                const locationDisplay = btcmapGetLocationDisplay(business);

                // Create website/social column content
                let websiteSocialContent = '';
                if (business.website) {
                    const websiteUrl = business.website.startsWith('http') ? business.website : `https://${business.website}`;
                    websiteSocialContent += `<a href="${websiteUrl}" target="_blank" rel="noopener noreferrer" class="btcmap-social-link" title="Website: ${business.website}">
                        <i class="bi bi-globe"></i>
                    </a>`;
                }

                // Add social media icons if available
                if (business.socialMedia) {
                    Object.entries(business.socialMedia).forEach(([platform, value]) => {
                        if (value) {
                            websiteSocialContent += `
                                <a href="${btcmapGetSocialUrl(platform, value)}" target="_blank" rel="noopener noreferrer" class="btcmap-social-link" title="${btcmapGetPlatformName(platform)}: ${value}">
                                    <i class="bi ${btcmapGetSocialMediaIcon(platform)}"></i>
                                </a>
                            `;
                        }
                    });
                }

                row.innerHTML = `
                    <td>${business.name}</td>
                    <td>${btcmapGetCategoryBadgesHTML(business.categories || [])}</td>
                    <td>${locationDisplay}</td>
                    <td class="btcmap-distance-column" style="display: ${hasLocation ? 'table-cell' : 'none'}">
                        ${business.distance !== undefined ? 
                            `<div class="btcmap-distance-badge">
                                <i class="bi bi-geo-alt"></i>${btcmapFormatDistance(business.distance)}
                            </div>` : 
                            '<em>N/A</em>'
                        }
                    </td>
                    <td class="text-start ps-0" style="white-space: nowrap;">${websiteSocialContent || '<em>Not available</em>'}</td>
                `;

                listContainer.appendChild(row);
            });
        }

        // Show business detail
        function btcmapShowBusinessDetail(businessId) {
            const business = btcmapBusinesses.find(b => b.id === businessId);
            if (!business) return;

            btcmapSelectedBusinessId = businessId;

            // Update detail panel
            document.getElementById('btcmap-detailName').textContent = business.name;
            document.getElementById('btcmap-detailCategories').innerHTML = btcmapGetCategoryBadgesHTML(business.categories || []);
            document.getElementById('btcmap-detailLocation').innerHTML = btcmapGetLocationDisplay(business);
            
            // Update payment methods
            const paymentMethodsEl = document.getElementById('btcmap-detailPaymentMethods');
            paymentMethodsEl.innerHTML = '';
            if (business.paymentMethods.onchain) {
                paymentMethodsEl.innerHTML += '<span class="btcmap-payment-badge btcmap-onchain-badge">Bitcoin Onchain</span>';
            }
            if (business.paymentMethods.lightning) {
                paymentMethodsEl.innerHTML += '<span class="btcmap-payment-badge btcmap-lightning-badge">Lightning Network</span>';
            }

            // Update website
            const websiteEl = document.getElementById('btcmap-detailWebsite');
            if (business.website) {
                websiteEl.innerHTML = `<a href="${business.website}" target="_blank">${business.website}</a>`;
            } else {
                websiteEl.textContent = 'Not available';
            }

            // Update social media
            const socialEl = document.getElementById('btcmap-detailSocial');
            socialEl.innerHTML = '';
            if (business.socialMedia) {
                Object.entries(business.socialMedia).forEach(([platform, value]) => {
                    if (value) {
                        socialEl.innerHTML += `
                            <a href="${btcmapGetSocialUrl(platform, value)}" 
                               class="btcmap-social-link" 
                               target="_blank" 
                               title="${platform}: ${value}">
                                <i class="bi ${btcmapGetSocialMediaIcon(platform)}"></i>
                            </a>
                        `;
                    }
                });
            }

            // Set up View on Map button click handler
            const viewOnMapBtn = document.getElementById('btcmap-viewOnMapBtn');
            viewOnMapBtn.onclick = () => {
                // Scroll to map
                document.getElementById('btcmap-map').scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'center'
                });
                
                // Center map on business location and zoom in
                if (business.coordinates && business.coordinates.lat && business.coordinates.lng) {
                    btcmapMap.setView([business.coordinates.lat, business.coordinates.lng], 15);
                    
                    // Add a temporary highlight effect to the marker
                    btcmapMarkers.forEach(marker => {
                        if (marker.getLatLng().equals([business.coordinates.lat, business.coordinates.lng])) {
                            const icon = marker.getIcon();
                            if (icon) {
                                // Add highlight class
                                icon.options.className = 'btcmap-custom-marker btcmap-marker-selected';
                                marker.setIcon(icon);
                                
                                // Remove highlight after 2 seconds
                                setTimeout(() => {
                                    if (btcmapSelectedBusinessId === businessId) {
                                        // Only remove highlight if this business is still selected
                                        icon.options.className = 'btcmap-custom-marker';
                                        marker.setIcon(icon);
                                    }
                                }, 2000);
                            }
                        }
                    });
                }
            };

            // Show detail panel and update layout
            document.getElementById('btcmap-businessDetail').style.display = 'block';
            document.getElementById('btcmap-mainContent').classList.add('btcmap-detail-visible');

            // Update list selection
            btcmapUpdateBusinessList(btcmapFilteredBusinesses);

            // Center map on business
            if (business.coordinates && business.coordinates.lat && business.coordinates.lng) {
                btcmapMap.setView([business.coordinates.lat, business.coordinates.lng], 15);
            }

            // Update markers
            btcmapMarkers.forEach(marker => {
                const icon = marker.getIcon();
                if (icon) {
                    icon.options.className = `btcmap-custom-marker${marker.getLatLng().equals([business.coordinates.lat, business.coordinates.lng]) ? ' btcmap-marker-selected' : ''}`;
                    marker.setIcon(icon);
                }
            });
        }

        // Helper functions
        function btcmapFormatAddress(address) {
            const parts = [];
            if (address.street) {
                parts.push(address.housenumber ? 
                    `${address.street} ${address.housenumber}` : 
                    address.street
                );
            }
            if (address.city) parts.push(address.city);
            if (address.state) parts.push(address.state);
            if (address.country) parts.push(address.country);
            return parts.join(', ') || 'Address not available';
        }

        function btcmapGetSocialIcon(platform) {
            const icons = {
                twitter: 'twitter-x',
                facebook: 'facebook',
                instagram: 'instagram',
                telegram: 'telegram'
            };
            return icons[platform] || 'link';
        }

        function btcmapGetSocialMediaIcon(platform) {
            const icons = {
                'twitter': 'bi-twitter-x',
                'facebook': 'bi-facebook',
                'instagram': 'bi-instagram',
                'linkedin': 'bi-linkedin',
                'youtube': 'bi-youtube',
                'telegram': 'bi-telegram',
                'signal': 'bi-chat-dots-fill',
                'whatsapp': 'bi-whatsapp',
                'discord': 'bi-discord',
                'reddit': 'bi-reddit',
                'github': 'bi-github',
                'mastodon': 'bi-mastodon',
                'matrix': 'bi-chat-square-text-fill',
                'keet': 'bi-chat-fill'
            };
            return icons[platform.toLowerCase()] || 'bi-link-45deg';
        }

        function btcmapGetPlatformName(platform) {
            const names = {
                'twitter': 'Twitter',
                'facebook': 'Facebook',
                'instagram': 'Instagram',
                'linkedin': 'LinkedIn',
                'youtube': 'YouTube',
                'telegram': 'Telegram',
                'signal': 'Signal',
                'whatsapp': 'WhatsApp',
                'discord': 'Discord',
                'reddit': 'Reddit',
                'github': 'GitHub',
                'mastodon': 'Mastodon',
                'nostr': 'Nostr',
                'matrix': 'Matrix',
                'keet': 'Keet'
            };
            return names[platform.toLowerCase()] || platform;
        }

        function btcmapGetSocialUrl(platform, value) {
            // Check if value is already a URL
            if (value.startsWith('http://') || value.startsWith('https://')) {
                return value;
            }
            
            switch(platform.toLowerCase()) {
                case 'facebook':
                    return `https://facebook.com/${value}`;
                case 'instagram':
                    return `https://instagram.com/${value.replace('@', '')}`;
                case 'linkedin':
                    return `https://linkedin.com/in/${value}`;
                case 'youtube':
                    return `https://youtube.com/${value}`;
                case 'telegram':
                    return value.startsWith('http') ? value : `https://t.me/${value}`;
                case 'signal':
                    return `signal://${value}`;
                case 'whatsapp':
                    return `https://wa.me/${value.replace(/[+\s-]/g, '')}`;
                case 'discord':
                    return `#`;
                case 'reddit':
                    return `https://reddit.com/user/${value}`;
                case 'github':
                    return `https://github.com/${value}`;
                case 'mastodon':
                    if (value.includes('@')) {
                        const parts = value.split('@');
                        if (parts.length === 3) {
                            return `https://${parts[2]}/@${parts[1]}`;
                        }
                    }
                    return `#`;
                case 'nostr':
                    return `https://njump.me/${value}`;
                case 'twitter':
                    return `https://twitter.com/${value.replace('@', '')}`;
                case 'matrix':
                    return value; // Use the Matrix URL directly from the JSON file
                default:
                    return `#`;
            }
        }

        function btcmapGetLocationDisplay(business) {
            const parts = [];
            if (business.address.street) {
                parts.push(business.address.housenumber ? 
                    `${business.address.street} ${business.address.housenumber}` : 
                    business.address.street
                );
            }
            if (business.address.city) parts.push(business.address.city);
            if (business.address.state) parts.push(business.address.state);
            if (business.address.country) parts.push(business.address.country);
            return parts.join(', ') || 'Address not available';
        }

        function btcmapGetCategoryBadgesHTML(categories) {
            return categories.map(cat => `
                <span class="badge bg-secondary me-1">${cat}</span>
            `).join('');
        }

        // Format distance helper function
        function btcmapFormatDistance(distance) {
            const km = distance / 1000;
            const miles = km * 0.621371;
            
            if (distance < 1000) {
                // Under 1km, show in meters
                return `${Math.round(distance)}m`;
            } else if (km < 10) {
                // Under 10km, show one decimal
                return `${miles.toFixed(1)}<span class="unit">mi</span> (${km.toFixed(1)}<span class="unit">km</span>)`;
            } else {
                // Over 10km, show whole numbers
                return `${Math.round(miles)}<span class="unit">mi</span> (${Math.round(km)}<span class="unit">km</span>)`;
            }
        }

        // Function to get user's location
        function btcmapGetUserLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation is not supported by your browser'));
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        btcmapUserLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        resolve(btcmapUserLocation);
                    },
                    (error) => {
                        reject(error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            });
        }

        // Function to calculate distance between two points
        function btcmapCalculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the earth in km
            const dLat = btcmapDeg2rad(lat2 - lat1);
            const dLon = btcmapDeg2rad(lon2 - lon1);
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(btcmapDeg2rad(lat1)) * Math.cos(btcmapDeg2rad(lat2)) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const d = R * c * 1000; // Distance in meters
            return d;
        }

        function btcmapDeg2rad(deg) {
            return deg * (Math.PI/180);
        }

        // Major cities data
        const btcmapCities = [
            { name: "New York, USA", lat: 40.7128, lng: -74.0060 },
            { name: "London, UK", lat: 51.5074, lng: -0.1278 },
            { name: "Paris, France", lat: 48.8566, lng: 2.3522 },
            { name: "Tokyo, Japan", lat: 35.6762, lng: 139.6503 },
            { name: "Sydney, Australia", lat: -33.8688, lng: 151.2093 },
            { name: "Dubai, UAE", lat: 25.2048, lng: 55.2708 },
            { name: "Singapore", lat: 1.3521, lng: 103.8198 },
            { name: "Hong Kong", lat: 22.3193, lng: 114.1694 },
            { name: "Berlin, Germany", lat: 52.5200, lng: 13.4050 },
            { name: "Madrid, Spain", lat: 40.4168, lng: -3.7038 },
            { name: "Rome, Italy", lat: 41.9028, lng: 12.4964 },
            { name: "Moscow, Russia", lat: 55.7558, lng: 37.6173 },
            { name: "Beijing, China", lat: 39.9042, lng: 116.4074 },
            { name: "Seoul, South Korea", lat: 37.5665, lng: 126.9780 },
            { name: "Mumbai, India", lat: 19.0760, lng: 72.8777 },
            { name: "SÃ£o Paulo, Brazil", lat: -23.5505, lng: -46.6333 },
            { name: "Mexico City, Mexico", lat: 19.4326, lng: -99.1332 },
            { name: "Cairo, Egypt", lat: 30.0444, lng: 31.2357 },
            { name: "Lagos, Nigeria", lat: 6.5244, lng: 3.3792 },
            { name: "Cape Town, South Africa", lat: -33.9249, lng: 18.4241 },
            { name: "Toronto, Canada", lat: 43.6532, lng: -79.3832 },
            { name: "Vancouver, Canada", lat: 49.2827, lng: -123.1207 },
            { name: "Amsterdam, Netherlands", lat: 52.3676, lng: 4.9041 },
            { name: "Bangkok, Thailand", lat: 13.7563, lng: 100.5018 },
            { name: "Istanbul, Turkey", lat: 41.0082, lng: 28.9784 }
        ];

        // Populate city list
        function btcmapPopulateCityList() {
            const cityList = document.getElementById('cityList');
            btcmapCities.forEach(city => {
                const li = document.createElement('li');
                li.innerHTML = `<a class="dropdown-item" href="#" data-lat="${city.lat}" data-lng="${city.lng}">${city.name}</a>`;
                cityList.appendChild(li);
            });

            // Add click handlers for city selection
            cityList.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const lat = parseFloat(e.target.dataset.lat);
                    const lng = parseFloat(e.target.dataset.lng);
                    document.getElementById('btcmap-locationDropdown').textContent = e.target.textContent;
                    btcmapHandleLocationSelection({ lat, lng }, e.target.textContent);
                });
            });
        }

        // Handle location selection (both manual and automatic)
        function btcmapHandleLocationSelection(location, locationName = 'your location') {
            btcmapUserLocation = location;
            btcmapMap.setView([location.lat, location.lng], 12);

            // Update location status
            document.getElementById('btcmap-locationStatus').innerHTML = 
                `<i class="bi bi-geo-alt"></i> Using distances from ${locationName} <span class="text-secondary">(${location.lat.toFixed(4)}, ${location.lng.toFixed(4)})</span>`;

            // Show the distance column
            document.querySelectorAll('.btcmap-distance-column').forEach(el => {
                el.style.display = 'table-cell';
            });

            // Update businesses with distance
            btcmapBusinesses.forEach(business => {
                if (business.coordinates && business.coordinates.lat && business.coordinates.lng) {
                    business.distance = btcmapCalculateDistance(
                        location.lat,
                        location.lng,
                        business.coordinates.lat,
                        business.coordinates.lng
                    );
                }
            });

            // Sort businesses by distance
            btcmapFilteredBusinesses = [...btcmapBusinesses].sort((a, b) => {
                if (!a.distance) return 1;
                if (!b.distance) return -1;
                return a.distance - b.distance;
            });

            // Update display
            btcmapAddMarkersToMap(btcmapFilteredBusinesses);
            btcmapUpdateBusinessList(btcmapFilteredBusinesses);
            document.getElementById('btcmap-filterStatus').textContent = 
                `Found ${btcmapFilteredBusinesses.length} Bitcoin-accepting businesses near ${locationName}`;
        }

        // Use My Location button handler
        document.getElementById('btcmap-useMyLocation').addEventListener('click', async () => {
            try {
                document.getElementById('btcmap-loadingSpinner').style.display = 'flex';
                const position = await btcmapGetUserLocation();
                // Reset the dropdown selection instead of changing its text
                document.getElementById('btcmap-locationDropdown').value = '';
                btcmapHandleLocationSelection(position, 'your current location');
            } catch (error) {
                console.error('Error getting location:', error);
                alert('Could not get your location. Please try selecting a city instead.');
            } finally {
                document.getElementById('btcmap-loadingSpinner').style.display = 'none';
            }
        });

        // Initialize city list on page load
        document.addEventListener('DOMContentLoaded', () => {
            btcmapPopulateCityList();
            // ... rest of existing initialization code ...
        });

        // Modify region select handler to remove location-specific code
        document.getElementById('btcmap-regionSelect').addEventListener('change', async (e) => {
            const region = e.target.value;
            
            try {
                document.getElementById('btcmap-loadingSpinner').style.display = 'flex';
                document.getElementById('btcmap-mainContent').style.display = 'none';

                const regionConfig = btcmapRegionBounds[region];
                btcmapMap.setView(regionConfig.center, regionConfig.zoom);
                
                // Hide the distance column for region views
                document.querySelectorAll('.btcmap-distance-column').forEach(el => {
                    el.style.display = 'none';
                });
                
                btcmapBusinesses = await btcmapFetchBusinesses(region);
                btcmapFilteredBusinesses = [...btcmapBusinesses];

                btcmapAddMarkersToMap(btcmapFilteredBusinesses);
                btcmapUpdateBusinessList(btcmapFilteredBusinesses);
                btcmapUpdateCategoryFilter(btcmapFilteredBusinesses);

                document.getElementById('btcmap-filterStatus').textContent = 
                    `Found ${btcmapFilteredBusinesses.length} Bitcoin-accepting businesses in ${region.replace('-', ' ')}`;
            } catch (error) {
                console.error('Error updating region:', error);
                document.getElementById('btcmap-filterStatus').textContent = 
                    'Error loading businesses. Please try again.';
            } finally {
                document.getElementById('btcmap-loadingSpinner').style.display = 'none';
                document.getElementById('btcmap-mainContent').style.display = 'block';
            }
        });

        document.getElementById('btcmap-searchInput').addEventListener('input', (e) => {
            btcmapFilterBusinesses();
        });

        document.getElementById('btcmap-categorySelect').addEventListener('change', () => {
            btcmapFilterBusinesses();
        });

        document.getElementById('btcmap-clearFilters').addEventListener('click', () => {
            document.getElementById('btcmap-searchInput').value = '';
            document.getElementById('btcmap-categorySelect').value = '';
            document.getElementById('btcmap-locationDropdown').value = '';
            document.getElementById('btcmap-locationStatus').innerHTML = '';
            btcmapUserLocation = null;
            // Reset category counts to original state
            btcmapUpdateCategoryFilter(btcmapBusinesses);
            btcmapFilterBusinesses();
        });

        document.getElementById('btcmap-closeDetail').addEventListener('click', () => {
            document.getElementById('btcmap-businessDetail').style.display = 'none';
            document.getElementById('btcmap-mainContent').classList.remove('btcmap-detail-visible');
            btcmapSelectedBusinessId = null;
            btcmapUpdateBusinessList(btcmapFilteredBusinesses);
            
            // Reset marker styling
            btcmapMarkers.forEach(marker => {
                const icon = marker.getIcon();
                if (icon) {
                    icon.options.className = 'btcmap-custom-marker';
                    marker.setIcon(icon);
                }
            });
        });

        // Filter businesses based on search and category
        function btcmapFilterBusinesses() {
            const searchTerm = document.getElementById('btcmap-searchInput').value.toLowerCase();
            const categorySelect = document.getElementById('btcmap-categorySelect');
            const category = categorySelect.value;

            btcmapFilteredBusinesses = btcmapBusinesses.filter(business => {
                const matchesSearch = !searchTerm || 
                    business.name.toLowerCase().includes(searchTerm) ||
                    business.categories.some(cat => cat.toLowerCase().includes(searchTerm)) ||
                    btcmapFormatAddress(business.address).toLowerCase().includes(searchTerm);

                const matchesCategory = !category || 
                    business.categories.includes(category);

                return matchesSearch && matchesCategory;
            });

            // Update markers and list
            btcmapAddMarkersToMap(btcmapFilteredBusinesses);
            btcmapUpdateBusinessList(btcmapFilteredBusinesses);
            
            // Update category counts based on current search filter
            if (searchTerm) {
                btcmapUpdateCategoryFilter(btcmapFilteredBusinesses);
                // Restore the selected category after updating options
                if (category) {
                    categorySelect.value = category;
                }
            } else {
                btcmapUpdateCategoryFilter(btcmapBusinesses);
                // Restore the selected category after updating options
                if (category) {
                    categorySelect.value = category;
                }
            }
            
            // Update status message
            const categoryText = category ? 
                ` in category "${category}"` : 
                '';
            const searchText = searchTerm ? 
                ` matching "${searchTerm}"` : 
                '';
            
            document.getElementById('btcmap-filterStatus').textContent = 
                `Showing ${btcmapFilteredBusinesses.length} of ${btcmapBusinesses.length} businesses${categoryText}${searchText}`;
        }

        // Update category filter options
        function btcmapUpdateCategoryFilter(businesses) {
            // Get counts for each category
            const categoryCounts = new Map();
            let totalBusinesses = businesses.length;
            
            // Count businesses in each category
            businesses.forEach(business => {
                business.categories.forEach(category => {
                    if (category) {
                        categoryCounts.set(category, (categoryCounts.get(category) || 0) + 1);
                    }
                });
            });

            const categorySelect = document.getElementById('btcmap-categorySelect');
            categorySelect.innerHTML = `<option value="">All Categories (${totalBusinesses})</option>`;
            
            // Convert to array, sort by count (descending) then alphabetically
            const sortedCategories = Array.from(categoryCounts.entries())
                .sort((a, b) => {
                    // First sort by count (descending)
                    if (b[1] !== a[1]) {
                        return b[1] - a[1];
                    }
                    // Then alphabetically
                    return a[0].localeCompare(b[0]);
                });
            
            // Add options with counts
            sortedCategories.forEach(([category, count]) => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = `${category} (${count})`;
                categorySelect.appendChild(option);
            });
        }

        // Add cache info to filter status
        function btcmapUpdateFilterStatus() {
            const region = document.getElementById('btcmap-regionSelect').value;
            const timestamp = localStorage.getItem(btcmapGetTimestampKey(region));
            let cacheInfo = '';
            
            if (timestamp) {
                const cacheDate = new Date(parseInt(timestamp));
                cacheInfo = ` â¢ Data cached ${cacheDate.toLocaleString()}`;
            }

            document.getElementById('btcmap-filterStatus').textContent = 
                `Showing ${btcmapFilteredBusinesses.length} of ${btcmapBusinesses.length} businesses${cacheInfo}`;
        }

        // Add cache clear button
        document.getElementById('btcmap-clearFilters').insertAdjacentHTML('afterend', `
            <button class="btn btn-outline-secondary ms-2" type="button" id="btcmap-clearCache">
                <i class="bi bi-arrow-clockwise"></i> Refresh Data
            </button>
        `);

        document.getElementById('btcmap-clearCache').addEventListener('click', async () => {
            const region = document.getElementById('btcmap-regionSelect').value;
            // Clear cache for current region
            localStorage.removeItem(btcmapGetCacheKey(region));
            localStorage.removeItem(btcmapGetTimestampKey(region));
            
            // Reload data
            try {
                document.getElementById('btcmap-loadingSpinner').style.display = 'flex';
                document.getElementById('btcmap-mainContent').style.display = 'none';
                
                btcmapBusinesses = await btcmapFetchBusinesses(region);
                btcmapFilteredBusinesses = [...btcmapBusinesses];
                
                btcmapAddMarkersToMap(btcmapBusinesses);
                btcmapUpdateBusinessList(btcmapBusinesses);
                btcmapUpdateCategoryFilter(btcmapBusinesses);
                btcmapUpdateFilterStatus();
            } finally {
                document.getElementById('btcmap-loadingSpinner').style.display = 'none';
                document.getElementById('btcmap-mainContent').style.display = 'block';
            }
        });

        // Add sorting functionality
        let btcmapCurrentSortColumn = null;
        let btcmapCurrentSortDirection = 'asc';

        // Add click handlers for sortable columns
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.btcmap-sortable').forEach(header => {
                header.addEventListener('click', () => {
                    const column = header.dataset.sort;
                    btcmapHandleSort(column);
                });
            });
        });

        function btcmapHandleSort(column) {
            if (column === btcmapCurrentSortColumn) {
                btcmapCurrentSortDirection = btcmapCurrentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                btcmapCurrentSortColumn = column;
                btcmapCurrentSortDirection = 'asc';
            }

            document.querySelectorAll('.btcmap-sortable').forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
                if (header.dataset.sort === column) {
                    header.classList.add(`sort-${btcmapCurrentSortDirection}`);
                }
            });

            btcmapSortBusinesses(column, btcmapCurrentSortDirection);
        }

        function btcmapSortBusinesses(column, direction) {
            const multiplier = direction === 'asc' ? 1 : -1;

            btcmapFilteredBusinesses.sort((a, b) => {
                switch (column) {
                    case 'name':
                        return multiplier * a.name.localeCompare(b.name);
                    case 'location':
                        const locA = btcmapFormatAddress(a.address);
                        const locB = btcmapFormatAddress(b.address);
                        return multiplier * locA.localeCompare(locB);
                    case 'distance':
                        if (a.distance === undefined && b.distance === undefined) return 0;
                        if (a.distance === undefined) return 1;
                        if (b.distance === undefined) return -1;
                        return multiplier * (a.distance - b.distance);
                    default:
                        return 0;
                }
            });

            btcmapUpdateBusinessList(btcmapFilteredBusinesses);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                document.getElementById('btcmap-loadingSpinner').style.display = 'flex';
                document.getElementById('btcmap-mainContent').style.display = 'block';
                
                // Initialize map first
                btcmapInitMap();
                
                const initialRegion = document.getElementById('btcmap-regionSelect').value;
                btcmapBusinesses = await btcmapFetchBusinesses(initialRegion);
                btcmapFilteredBusinesses = [...btcmapBusinesses];
                
                btcmapAddMarkersToMap(btcmapBusinesses);
                btcmapUpdateBusinessList(btcmapBusinesses);
                btcmapUpdateCategoryFilter(btcmapBusinesses);
                
                document.getElementById('btcmap-filterStatus').textContent = 
                    `Found ${btcmapBusinesses.length} Bitcoin-accepting businesses in ${initialRegion.replace('-', ' ')}`;
            } catch (error) {
                console.error('Error initializing map:', error);
                document.getElementById('btcmap-filterStatus').textContent = 
                    'Error loading businesses. Please try again.';
            } finally {
                document.getElementById('btcmap-loadingSpinner').style.display = 'none';
            }
        });

        // Update location selection handler
        document.getElementById('btcmap-locationDropdown').addEventListener('change', (e) => {
            if (!e.target.value) {
                // Reset if "Select a city" is chosen
                btcmapUserLocation = null;
                document.querySelectorAll('.btcmap-distance-column').forEach(el => {
                    el.style.display = 'none';
                });
                document.getElementById('btcmap-locationStatus').innerHTML = '';
                return;
            }
            
            const [lat, lng] = e.target.value.split(',').map(Number);
            const locationName = e.target.options[e.target.selectedIndex].text;
            btcmapHandleLocationSelection({ lat, lng }, locationName);
        });
    </script>
</body>
</html> 