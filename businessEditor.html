<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Business Data Editor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            padding-bottom: 60px;
        }
        .header {
            background-color: #f7931a;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
        }
        .bitcoin-icon {
            height: 80px;
            margin-right: 10px;
            vertical-align: middle;
        }
        .header h1 {
            display: inline-block;
            margin: 0;
            vertical-align: middle;
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 700;
        }
        .header p {
            font-family: 'Roboto Condensed', sans-serif;
        }
        .content-section {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            padding: 20px;
            margin-bottom: 30px;
        }
        .table-responsive {
            overflow-x: auto;
        }
        .business-row {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .business-row:hover {
            background-color: #f1f1f1;
        }
        .business-row.selected {
            background-color: #e7f5ff;
        }
        .business-actions {
            white-space: nowrap;
        }
        .sort-icon {
            cursor: pointer;
            margin-left: 5px;
        }
        .modal-xl {
            max-width: 95%;
        }
        .category-container {
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
        }
        .selected-categories {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 0.25rem;
            border: 1px solid #ced4da;
        }
        .category-badge {
            display: inline-block;
            margin-right: 5px;
            margin-bottom: 5px;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            font-weight: normal;
            line-height: 1.5;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.25rem;
            color: #fff;
            background-color: #6c757d;
        }
        .category-badge .remove-category {
            margin-left: 5px;
            cursor: pointer;
        }
        .payment-methods {
            margin-top: 10px;
        }
        .social-media-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        .fixed-bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #fff;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        .sticky-top-actions {
            position: sticky;
            top: 0;
            z-index: 900;
            background-color: white;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }
        .upload-area {
            border: 2px dashed #ccc;
            padding: 2rem;
            text-align: center;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: #f7931a;
            background-color: #fff8f0;
        }
        .upload-area.highlight {
            border-color: #f7931a;
            background-color: #fff8f0;
        }
        .drag-text {
            margin: 20px 0;
        }
        .category-group {
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 10px;
            background-color: #f9f9f9;
            margin-bottom: 10px;
        }
        .main-category-heading {
            font-weight: bold;
        }
        .subcategories {
            border-top: 1px dashed #ddd;
            padding-top: 8px;
            margin-top: 5px;
        }
        .validation-error {
            color: #dc3545;
            margin-top: 0.25rem;
            font-size: 0.875em;
        }
        .json-preview {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            overflow-x: auto;
            font-family: monospace;
        }
        .status-bar {
            background-color: #e9ecef;
            padding: 8px 16px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        .status-info {
            color: #0d6efd;
        }
        #spinnerBackdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .spinner-container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
        }
        .custom-file-input::-webkit-file-upload-button {
            visibility: hidden;
        }
        .custom-file-input::before {
            content: 'Select file';
            display: inline-block;
            background: linear-gradient(top, #f9f9f9, #e3e3e3);
            border: 1px solid #999;
            border-radius: 3px;
            padding: 5px 8px;
            outline: none;
            white-space: nowrap;
            -webkit-user-select: none;
            cursor: pointer;
            text-shadow: 1px 1px #fff;
            font-weight: 700;
            font-size: 10pt;
        }
        .custom-file-input:hover::before {
            border-color: black;
        }
        .custom-file-input:active::before {
            background: -webkit-linear-gradient(top, #e3e3e3, #f9f9f9);
        }
        #mainContent {
            display: none;
        }
        #welcomeScreen {
            text-align: center;
            padding: 40px 20px;
        }
        .welcome-box {
            max-width: 600px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 30px;
        }
        .welcome-icon {
            font-size: 3rem;
            color: #f7931a;
            margin-bottom: 20px;
        }
        .error-message {
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 10px;
            margin-top: 15px;
            display: none;
        }
        /* Add these styles for the preview */
        #markdownPreview {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
        }
        
        #markdownPreview h1,
        #markdownPreview h2,
        #markdownPreview h3,
        #markdownPreview h4,
        #markdownPreview h5,
        #markdownPreview h6 {
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        
        #markdownPreview p {
            margin-bottom: 1rem;
        }
        
        #markdownPreview ul,
        #markdownPreview ol {
            padding-left: 2rem;
            margin-bottom: 1rem;
        }
        
        #markdownPreview blockquote {
            border-left: 3px solid #f7931a;
            padding-left: 1rem;
            margin-left: 0;
            color: #666;
        }
        
        #markdownPreview code {
            background-color: #f8f9fa;
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-size: 85%;
        }
        
        #markdownPreview pre {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 5px;
            overflow-x: auto;
        }
        
        #markdownPreview a {
            color: #f7931a;
            text-decoration: none;
        }
        
        #markdownPreview a:hover {
            text-decoration: underline;
        }
        
        #markdownPreview img {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
            margin: 1rem 0;
        }
        
        /* Nostr npubs styles */
        .nostr-npub-item {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f8f9fa;
            transition: background-color 0.2s ease;
        }
        
        .nostr-npub-item:hover {
            background-color: #e9ecef;
        }
        
        .nostr-business-name {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        
        .nostr-npub-container {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: white;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 8px;
        }
        
        .nostr-npub-text {
            font-family: monospace;
            font-size: 0.9rem;
            color: #6c757d;
            flex: 1;
            word-break: break-all;
            margin: 0;
        }
        
        .nostr-copy-btn {
            background-color: #f7931a;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background-color 0.2s ease;
            white-space: nowrap;
        }
        
        .nostr-copy-btn:hover {
            background-color: #e07d16;
        }
        
        .nostr-copy-btn.copied {
            background-color: #28a745;
        }
        
        .nostr-verified-date {
            font-size: 0.85rem;
            color: #6c757d;
            font-style: italic;
        }
        
        .nostr-copied-indicator {
            color: #28a745;
            font-size: 1.2rem;
            margin-left: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .nostr-copied-indicator.visible {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Loading Spinner -->
    <div id="spinnerBackdrop" style="display: none;">
        <div class="spinner-container">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mb-0" id="spinnerMessage">Processing...</p>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="container">
            <div class="d-flex">
                <div class="d-flex align-items-center">
                    <a href="businessEditor.html">
                        <img src="images/icons/btcLogo.svg" alt="Bitcoin Logo" class="bitcoin-icon">
                    </a>
                </div>
                <div>
                    <a href="businessEditor.html" class="text-white text-decoration-none">
                        <h1>BTCAccepted</h1>
                    </a>
                    <p class="mb-0">Import, edit, and export your Bitcoin-accepting businesses directory</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Welcome Screen -->
    <div id="welcomeScreen" class="container">
        <div class="welcome-box">
            <div class="welcome-icon">
                <i class="bi bi-file-earmark-code"></i>
            </div>
            <h2>Welcome to the Bitcoin Business Data Editor</h2>
            <p class="lead my-4">Import your businessData.json file or start from scratch to create and manage your Bitcoin-accepting businesses directory.</p>
            
            <div class="row mt-4">
                <div class="col-md-4 mb-3">
                    <button id="importButton" class="btn btn-primary w-100" style="background-color: #f7931a; border-color: #f7931a;">
                        <i class="bi bi-upload me-2"></i>Import JSON File
                    </button>
                </div>
                <div class="col-md-4 mb-3">
                    <button id="loadFromWebsiteButton" class="btn btn-primary w-100" style="background-color: #f7931a; border-color: #f7931a;">
                        <i class="bi bi-cloud-download me-2"></i>Load From Website
                    </button>
                </div>
                <div class="col-md-4 mb-3">
                    <button id="startNewButton" class="btn btn-outline-secondary w-100">
                        <i class="bi bi-plus-circle me-2"></i>Start New Collection
                    </button>
                </div>
            </div>
            
            <input type="file" id="jsonFileInput" accept=".json" style="display: none;">
            
            <div id="errorMessage" class="error-message mt-3"></div>
        </div>
    </div>

    <!-- Main Content (Initially Hidden) -->
    <div id="mainContent" class="container" style="display: none;">
        <div class="status-bar">
            <div class="row">
                <div class="col-md-6">
                    <span id="fileNameDisplay"><i class="bi bi-file-earmark-code"></i> No file loaded</span>
                </div>
                <div class="col-md-6 text-end">
                    <span id="businessCount" class="status-info"><i class="bi bi-shop"></i> 0 businesses</span>
                </div>
            </div>
        </div>

        <div class="sticky-top-actions">
            <div class="row">
                <div class="col-md-6 mb-2">
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchInput" placeholder="Search businesses...">
                        <button class="btn btn-outline-secondary" type="button" id="clearSearchButton">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-6 mb-2 text-md-end">
                    <button id="addBusinessButton" class="btn btn-success">
                        <i class="bi bi-plus-lg"></i> Add Business
                    </button>
                    <button id="nostrNpubsButton" class="btn btn-outline-info" title="View Nostr npubs">
                        <i class="bi bi-broadcast"></i> Nostr npubs
                    </button>
                    <button id="exportJsonButton" class="btn btn-primary" style="background-color: #f7931a; border-color: #f7931a;">
                        <i class="bi bi-download"></i> Export JSON
                    </button>
                </div>
            </div>
        </div>

        <div class="content-section">
            <div class="table-responsive">
                <table class="table table-hover" id="businessesTable">
                    <thead>
                        <tr>
                            <th width="30">
                                <input type="checkbox" id="selectAllCheckbox" class="form-check-input">
                            </th>
                            <th>Name <i class="bi bi-arrow-down-up sort-icon" data-sort="name"></i></th>
                            <th>Categories</th>
                            <th>Location <i class="bi bi-arrow-down-up sort-icon" data-sort="location"></i></th>
                            <th>Payment Methods</th>
                            <th>Last Verified <i class="bi bi-arrow-down-up sort-icon" data-sort="lastVerified"></i></th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="businessesTableBody">
                        <!-- Business data will be populated here -->
                    </tbody>
                </table>
            </div>
            
            <div id="noBusinessesMessage" class="text-center py-5">
                <div class="text-muted">
                    <i class="bi bi-shop" style="font-size: 3rem;"></i>
                    <h4 class="mt-3">No businesses found</h4>
                    <p>Start by adding a new business or importing a JSON file.</p>
                </div>
            </div>
        </div>
        
        <div class="fixed-bottom-bar">
            <div class="container">
                <div class="row">
                    <div class="col-md-6">
                        <div class="btn-group" id="bulkActionButtons" style="display: none;">
                            <button class="btn btn-outline-danger" id="deleteSelectedButton">
                                <i class="bi bi-trash"></i> Delete Selected
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-outline-secondary me-2" id="importNewButton">
                            <i class="bi bi-upload"></i> Import New File
                        </button>
                        <button class="btn btn-primary" id="saveChangesButton" style="background-color: #f7931a; border-color: #f7931a;">
                            <i class="bi bi-download"></i> Export JSON
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Business Modal -->
    <div class="modal fade" id="businessModal" tabindex="-1" aria-labelledby="businessModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="businessModalLabel">Edit Business</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="businessForm">
                        <input type="hidden" id="businessId">
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="businessName" class="form-label">Business Name *</label>
                                <input type="text" class="form-control" id="businessName" required>
                                <div class="validation-error" id="businessNameError"></div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="businessSlug" class="form-label">Business Slug</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="businessSlug" placeholder="Generated automatically">
                                    <button class="btn btn-outline-secondary" type="button" id="generateSlugButton">Generate</button>
                                </div>
                                <div class="form-text">URL-friendly identifier. Leave blank to generate automatically from name.</div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Categories *</label>
                                <div class="border rounded p-3">
                                    <!-- Main categories section -->
                                    <div class="row mb-3">
                                        <div class="col-lg-3 col-md-4 col-sm-6 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input main-category" type="checkbox" id="cat-books" value="Books/Magazines">
                                                <label class="form-check-label" for="cat-books">Books/Magazines</label>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-4 col-sm-6 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input main-category" type="checkbox" id="cat-bitcoin-hardware" value="Bitcoin Hardware">
                                                <label class="form-check-label" for="cat-bitcoin-hardware">Bitcoin Hardware</label>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-4 col-sm-6 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input main-category" type="checkbox" id="cat-consulting" value="Consulting">
                                                <label class="form-check-label" for="cat-consulting">Consulting</label>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-4 col-sm-6 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input main-category" type="checkbox" id="cat-event" value="Event Organizer">
                                                <label class="form-check-label" for="cat-event">Event Organizer</label>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-4 col-sm-6 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input main-category" type="checkbox" id="cat-gift-cards" value="Gift Cards">
                                                <label class="form-check-label" for="cat-gift-cards">Gift Cards</label>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-4 col-sm-6 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input main-category" type="checkbox" id="cat-hardware-wallets" value="Hardware Wallets/Signing Devices">
                                                <label class="form-check-label" for="cat-hardware-wallets">Hardware Wallets/Signing Devices</label>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-4 col-sm-6 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input main-category" type="checkbox" id="cat-homesteading" value="Homesteading">
                                                <label class="form-check-label" for="cat-homesteading">Homesteading</label>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-4 col-sm-6 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input main-category" type="checkbox" id="cat-lawyer" value="Lawyer">
                                                <label class="form-check-label" for="cat-lawyer">Lawyer</label>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-4 col-sm-6 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input main-category" type="checkbox" id="cat-marketplace" value="Marketplace">
                                                <label class="form-check-label" for="cat-marketplace">Marketplace</label>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-4 col-sm-6 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input main-category" type="checkbox" id="cat-merchandise" value="Merchandise">
                                                <label class="form-check-label" for="cat-merchandise">Merchandise</label>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Parent categories with subcategories -->
                                    <!-- Apparel and Accessories category -->
                                    <div class="category-group mb-3">
                                        <div class="main-category-heading">
                                            <div class="form-check">
                                                <input class="form-check-input main-category" type="checkbox" id="cat-apparel" value="Apparel and Accessories">
                                                <label class="form-check-label fw-bold" for="cat-apparel">Apparel and Accessories</label>
                                            </div>
                                        </div>
                                        <div class="subcategories ps-4 mt-1">
                                            <div class="row">
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-apparel-clothing" value="Clothing" data-parent="Apparel and Accessories">
                                                        <label class="form-check-label" for="subcat-apparel-clothing">Clothing</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-apparel-fashion" value="Fashion accessories" data-parent="Apparel and Accessories">
                                                        <label class="form-check-label" for="subcat-apparel-fashion">Fashion accessories</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-apparel-headwear" value="Headwear" data-parent="Apparel and Accessories">
                                                        <label class="form-check-label" for="subcat-apparel-headwear">Headwear</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-apparel-leather" value="Leather products" data-parent="Apparel and Accessories">
                                                        <label class="form-check-label" for="subcat-apparel-leather">Leather products</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Bitcoin Mining category -->
                                    <div class="category-group mb-3">
                                        <div class="main-category-heading">
                                            <div class="form-check">
                                                <input class="form-check-input main-category" type="checkbox" id="cat-mining" value="Bitcoin Mining">
                                                <label class="form-check-label fw-bold" for="cat-mining">Bitcoin Mining</label>
                                            </div>
                                        </div>
                                        <div class="subcategories ps-4 mt-1">
                                            <div class="row">
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-mining-accessories" value="Accessories" data-parent="Bitcoin Mining">
                                                        <label class="form-check-label" for="subcat-mining-accessories">Accessories</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-mining-hardware" value="Hardware" data-parent="Bitcoin Mining">
                                                        <label class="form-check-label" for="subcat-mining-hardware">Hardware</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-mining-home" value="Home Mining" data-parent="Bitcoin Mining">
                                                        <label class="form-check-label" for="subcat-mining-home">Home Mining</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-mining-hosted" value="Hosted" data-parent="Bitcoin Mining">
                                                        <label class="form-check-label" for="subcat-mining-hosted">Hosted</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Creative category -->
                                    <div class="category-group mb-3">
                                        <div class="main-category-heading">
                                            <div class="form-check">
                                                <input class="form-check-input main-category" type="checkbox" id="cat-creative" value="Creative">
                                                <label class="form-check-label fw-bold" for="cat-creative">Creative</label>
                                            </div>
                                        </div>
                                        <div class="subcategories ps-4 mt-1">
                                            <div class="row">
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-advertising" value="Advertising & Marketing" data-parent="Creative">
                                                        <label class="form-check-label" for="subcat-advertising">Advertising & Marketing</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-art" value="Art" data-parent="Creative">
                                                        <label class="form-check-label" for="subcat-art">Art</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-graphic-design" value="Graphic Design" data-parent="Creative">
                                                        <label class="form-check-label" for="subcat-graphic-design">Graphic Design</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-media" value="Media Production" data-parent="Creative">
                                                        <label class="form-check-label" for="subcat-media">Media Production</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-photography" value="Photography" data-parent="Creative">
                                                        <label class="form-check-label" for="subcat-photography">Photography</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-pins" value="Pins" data-parent="Creative">
                                                        <label class="form-check-label" for="subcat-pins">Pins</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-prints" value="Prints" data-parent="Creative">
                                                        <label class="form-check-label" for="subcat-prints">Prints</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-stickers" value="Stickers" data-parent="Creative">
                                                        <label class="form-check-label" for="subcat-stickers">Stickers</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-webdev" value="Web Developer" data-parent="Creative">
                                                        <label class="form-check-label" for="subcat-webdev">Web Developer</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Education category -->
                                    <div class="category-group mb-3">
                                        <div class="main-category-heading">
                                            <div class="form-check">
                                                <input class="form-check-input main-category" type="checkbox" id="cat-education" value="Education">
                                                <label class="form-check-label fw-bold" for="cat-education">Education</label>
                                            </div>
                                        </div>
                                        <div class="subcategories ps-4 mt-1">
                                            <div class="row">
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-books" value="Educational Books" data-parent="Education">
                                                        <label class="form-check-label" for="subcat-books">Educational Books</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-economics" value="Economics" data-parent="Education">
                                                        <label class="form-check-label" for="subcat-economics">Economics</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-homeschooling" value="Homeschooling" data-parent="Education">
                                                        <label class="form-check-label" for="subcat-homeschooling">Homeschooling</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Finance category -->
                                    <div class="category-group mb-3">
                                        <div class="main-category-heading">
                                            <div class="form-check">
                                                <input class="form-check-input main-category" type="checkbox" id="cat-finance" value="Finance">
                                                <label class="form-check-label fw-bold" for="cat-finance">Finance</label>
                                            </div>
                                        </div>
                                        <div class="subcategories ps-4 mt-1">
                                            <div class="row">
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-accounting" value="Accounting" data-parent="Finance">
                                                        <label class="form-check-label" for="subcat-accounting">Accounting</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-estate-admin" value="Estate and Trust Administration" data-parent="Finance">
                                                        <label class="form-check-label" for="subcat-estate-admin">Estate and Trust Administration</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-estate-planning" value="Estate, tax and business planning" data-parent="Finance">
                                                        <label class="form-check-label" for="subcat-estate-planning">Estate, tax and business planning</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-financial-advisors" value="Financial Advisors" data-parent="Finance">
                                                        <label class="form-check-label" for="subcat-financial-advisors">Financial Advisors</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Online Services category -->
                                    <div class="category-group mb-3">
                                        <div class="main-category-heading">
                                            <div class="form-check">
                                                <input class="form-check-input main-category" type="checkbox" id="cat-online-services" value="Online Services">
                                                <label class="form-check-label fw-bold" for="cat-online-services">Online Services</label>
                                            </div>
                                        </div>
                                        <div class="subcategories ps-4 mt-1">
                                            <div class="row">
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-ai" value="AI" data-parent="Online Services">
                                                        <label class="form-check-label" for="subcat-ai">AI</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-lightning-node" value="Lightning Node" data-parent="Online Services">
                                                        <label class="form-check-label" for="subcat-lightning-node">Lightning Node</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-online-payments" value="Payments & Processing" data-parent="Online Services">
                                                        <label class="form-check-label" for="subcat-online-payments">Payments & Processing</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-search" value="Search" data-parent="Online Services">
                                                        <label class="form-check-label" for="subcat-search">Search</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Food & Drink category -->
                                    <div class="category-group mb-3">
                                        <div class="main-category-heading">
                                            <div class="form-check">
                                                <input class="form-check-input main-category" type="checkbox" id="cat-food" value="Food & Drink">
                                                <label class="form-check-label fw-bold" for="cat-food">Food & Drink</label>
                                            </div>
                                        </div>
                                        <div class="subcategories ps-4 mt-1">
                                            <div class="row">
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-apiculture" value="Apiculture/Honey" data-parent="Food & Drink">
                                                        <label class="form-check-label" for="subcat-apiculture">Apiculture/Honey</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-bakery" value="Bakery" data-parent="Food & Drink">
                                                        <label class="form-check-label" for="subcat-bakery">Bakery</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-bar" value="Bar" data-parent="Food & Drink">
                                                        <label class="form-check-label" for="subcat-bar">Bar</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-brewery" value="Brewery" data-parent="Food & Drink">
                                                        <label class="form-check-label" for="subcat-brewery">Brewery</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-coffee" value="Coffee" data-parent="Food & Drink">
                                                        <label class="form-check-label" for="subcat-coffee">Coffee</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-eggs" value="Eggs" data-parent="Food & Drink">
                                                        <label class="form-check-label" for="subcat-eggs">Eggs</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-farm" value="Farm" data-parent="Food & Drink">
                                                        <label class="form-check-label" for="subcat-farm">Farm</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-food-supplements" value="Supplements" data-parent="Food & Drink">
                                                        <label class="form-check-label" for="subcat-food-supplements">Supplements</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-maple-syrup" value="Maple Syrup" data-parent="Food & Drink">
                                                        <label class="form-check-label" for="subcat-maple-syrup">Maple Syrup</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-meat" value="Meat" data-parent="Food & Drink">
                                                        <label class="form-check-label" for="subcat-meat">Meat</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-restaurant" value="Restaurant" data-parent="Food & Drink">
                                                        <label class="form-check-label" for="subcat-restaurant">Restaurant</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-tea" value="Tea" data-parent="Food & Drink">
                                                        <label class="form-check-label" for="subcat-tea">Tea</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-wine" value="Wine/Vineyard" data-parent="Food & Drink">
                                                        <label class="form-check-label" for="subcat-wine">Wine/Vineyard</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Health & Fitness category -->
                                    <div class="category-group mb-3">
                                        <div class="main-category-heading">
                                            <div class="form-check">
                                                <input class="form-check-input main-category" type="checkbox" id="cat-health" value="Health & Fitness">
                                                <label class="form-check-label fw-bold" for="cat-health">Health & Fitness</label>
                                            </div>
                                        </div>
                                        <div class="subcategories ps-4 mt-1">
                                            <div class="row">
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-acupuncture" value="Acupuncture" data-parent="Health & Fitness">
                                                        <label class="form-check-label" for="subcat-acupuncture">Acupuncture</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-chiropractic" value="Chiropractic" data-parent="Health & Fitness">
                                                        <label class="form-check-label" for="subcat-chiropractic">Chiropractic</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-dental" value="Dental & Orthodontics" data-parent="Health & Fitness">
                                                        <label class="form-check-label" for="subcat-dental">Dental & Orthodontics</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-healthcare" value="Healthcare" data-parent="Health & Fitness">
                                                        <label class="form-check-label" for="subcat-healthcare">Healthcare</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-health-supplements" value="Supplements" data-parent="Health & Fitness">
                                                        <label class="form-check-label" for="subcat-health-supplements">Supplements</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-massage" value="Massage Therapy" data-parent="Health & Fitness">
                                                        <label class="form-check-label" for="subcat-massage">Massage Therapy</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-skin-care" value="Skin Care" data-parent="Health & Fitness">
                                                        <label class="form-check-label" for="subcat-skin-care">Skin Care</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-swimming" value="Swimming" data-parent="Health & Fitness">
                                                        <label class="form-check-label" for="subcat-swimming">Swimming</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-beauty" value="Beauty/Cosmetic" data-parent="Health & Fitness">
                                                        <label class="form-check-label" for="subcat-beauty">Beauty/Cosmetic</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-personal-care" value="Personal Care" data-parent="Health & Fitness">
                                                        <label class="form-check-label" for="subcat-personal-care">Personal Care</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Music category -->
                                    <div class="category-group mb-3">
                                        <div class="main-category-heading">
                                            <div class="form-check">
                                                <input class="form-check-input main-category" type="checkbox" id="cat-music" value="Music">
                                                <label class="form-check-label fw-bold" for="cat-music">Music</label>
                                            </div>
                                        </div>
                                        <div class="subcategories ps-4 mt-1">
                                            <div class="row">
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-music-equipment" value="Equipment" data-parent="Music">
                                                        <label class="form-check-label" for="subcat-music-equipment">Equipment</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-music-lessons" value="Lessons" data-parent="Music">
                                                        <label class="form-check-label" for="subcat-music-lessons">Lessons</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-recording-studio" value="Recording Studio" data-parent="Music">
                                                        <label class="form-check-label" for="subcat-recording-studio">Recording Studio</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-streaming" value="Streaming" data-parent="Music">
                                                        <label class="form-check-label" for="subcat-streaming">Streaming</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Pet Care category -->
                                    <div class="category-group mb-3">
                                        <div class="main-category-heading">
                                            <div class="form-check">
                                                <input class="form-check-input main-category" type="checkbox" id="cat-pet-care" value="Pet Care">
                                                <label class="form-check-label fw-bold" for="cat-pet-care">Pet Care</label>
                                            </div>
                                        </div>
                                        <div class="subcategories ps-4 mt-1">
                                            <div class="row">
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-pet-store" value="Pet Store" data-parent="Pet Care">
                                                        <label class="form-check-label" for="subcat-pet-store">Pet Store</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-pet-daycare" value="Pet Day Care" data-parent="Pet Care">
                                                        <label class="form-check-label" for="subcat-pet-daycare">Pet Day Care</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-pet-boarding" value="Boarding" data-parent="Pet Care">
                                                        <label class="form-check-label" for="subcat-pet-boarding">Boarding</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-veterinary" value="Veterinary" data-parent="Pet Care">
                                                        <label class="form-check-label" for="subcat-veterinary">Veterinary</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-pet-accessories" value="Pet Accessories" data-parent="Pet Care">
                                                        <label class="form-check-label" for="subcat-pet-accessories">Pet Accessories</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-pet-food" value="Pet Food" data-parent="Pet Care">
                                                        <label class="form-check-label" for="subcat-pet-food">Pet Food</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-pet-grooming" value="Pet Grooming" data-parent="Pet Care">
                                                        <label class="form-check-label" for="subcat-pet-grooming">Pet Grooming</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-pet-health" value="Pet Health" data-parent="Pet Care">
                                                        <label class="form-check-label" for="subcat-pet-health">Pet Health</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-pet-training" value="Pet Training" data-parent="Pet Care">
                                                        <label class="form-check-label" for="subcat-pet-training">Pet Training</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Sports category -->
                                    <div class="category-group mb-3">
                                        <div class="main-category-heading">
                                            <div class="form-check">
                                                <input class="form-check-input main-category" type="checkbox" id="cat-sports" value="Sports">
                                                <label class="form-check-label fw-bold" for="cat-sports">Sports</label>
                                            </div>
                                        </div>
                                        <div class="subcategories ps-4 mt-1">
                                            <div class="row">
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-sports-apparel" value="Apparel" data-parent="Sports">
                                                        <label class="form-check-label" for="subcat-sports-apparel">Apparel</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-sports-equipment" value="Equipment" data-parent="Sports">
                                                        <label class="form-check-label" for="subcat-sports-equipment">Equipment</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-sports-memorabilia" value="Memorabilia" data-parent="Sports">
                                                        <label class="form-check-label" for="subcat-sports-memorabilia">Memorabilia</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-sports-teams" value="Teams" data-parent="Sports">
                                                        <label class="form-check-label" for="subcat-sports-teams">Teams</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-sports-tickets" value="Tickets" data-parent="Sports">
                                                        <label class="form-check-label" for="subcat-sports-tickets">Tickets</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-sports-training" value="Training" data-parent="Sports">
                                                        <label class="form-check-label" for="subcat-sports-training">Training</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Trades category -->
                                    <div class="category-group mb-3">
                                        <div class="main-category-heading">
                                            <div class="form-check">
                                                <input class="form-check-input main-category" type="checkbox" id="cat-trades" value="Trades">
                                                <label class="form-check-label fw-bold" for="cat-trades">Trades</label>
                                            </div>
                                        </div>
                                        <div class="subcategories ps-4 mt-1">
                                            <div class="row">
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-carpentry" value="Carpentry" data-parent="Trades">
                                                        <label class="form-check-label" for="subcat-carpentry">Carpentry</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-cardetailing" value="Car Detailing" data-parent="Trades">
                                                        <label class="form-check-label" for="subcat-cardetailing">Car Detailing</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-construction" value="Construction" data-parent="Trades">
                                                        <label class="form-check-label" for="subcat-construction">Construction</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-drywall" value="Drywall" data-parent="Trades">
                                                        <label class="form-check-label" for="subcat-drywall">Drywall</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-electrical" value="Electrical" data-parent="Trades">
                                                        <label class="form-check-label" for="subcat-electrical">Electrical</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-gardening" value="Gardening" data-parent="Trades">
                                                        <label class="form-check-label" for="subcat-gardening">Gardening</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-heating" value="Heating" data-parent="Trades">
                                                        <label class="form-check-label" for="subcat-heating">Heating</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-landscaping" value="Landscaping" data-parent="Trades">
                                                        <label class="form-check-label" for="subcat-landscaping">Landscaping</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-plumbing" value="Plumbing" data-parent="Trades">
                                                        <label class="form-check-label" for="subcat-plumbing">Plumbing</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-roofing" value="Roofing" data-parent="Trades">
                                                        <label class="form-check-label" for="subcat-roofing">Roofing</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-treecare" value="Tree Care" data-parent="Trades">
                                                        <label class="form-check-label" for="subcat-treecare">Tree Care</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Travel category -->
                                    <div class="category-group mb-3">
                                        <div class="main-category-heading">
                                            <div class="form-check">
                                                <input class="form-check-input main-category" type="checkbox" id="cat-travel" value="Travel">
                                                <label class="form-check-label fw-bold" for="cat-travel">Travel</label>
                                            </div>
                                        </div>
                                        <div class="subcategories ps-4 mt-1">
                                            <div class="row">
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-travel-airfare" value="Airfare" data-parent="Travel">
                                                        <label class="form-check-label" for="subcat-travel-airfare">Airfare</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-travel-cruises" value="Cruises" data-parent="Travel">
                                                        <label class="form-check-label" for="subcat-travel-cruises">Cruises</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-travel-accommodations" value="Hotels/Accommodations" data-parent="Travel">
                                                        <label class="form-check-label" for="subcat-travel-accommodations">Hotels/Accommodations</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-travel-tours" value="Tours" data-parent="Travel">
                                                        <label class="form-check-label" for="subcat-travel-tours">Tours</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-travel-transportation" value="Transportation" data-parent="Travel">
                                                        <label class="form-check-label" for="subcat-travel-transportation">Transportation</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3 col-md-4 col-sm-6 mb-1">
                                                    <div class="form-check">
                                                        <input class="form-check-input subcategory" type="checkbox" id="subcat-travel-agencies" value="Travel Agencies" data-parent="Travel">
                                                        <label class="form-check-label" for="subcat-travel-agencies">Travel Agencies</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Custom Category -->
                        <div class="mb-3">
                            <label class="form-label">Add Custom Category</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="customCategory" placeholder="Enter custom category">
                                <button class="btn btn-outline-secondary" type="button" id="addCustomCategoryBtn">Add</button>
                            </div>
                        </div>

                        <!-- Selected Categories Display -->
                        <div id="selectedCategoriesDisplay" class="selected-categories" style="display: none;">
                            <label class="form-label">Selected Categories</label>
                            <div id="selectedCategoriesList"></div>
                            <div class="validation-error" id="categoryError"></div>
                        </div>

                        <!-- Business Details -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="businessWebsite" class="form-label">Business Website</label>
                                <input type="text" class="form-control" id="businessWebsite">
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="row">
                                    <div class="col-8">
                                        <label for="businessCountry" class="form-label">Country</label>
                                        <input type="text" class="form-control" id="businessCountry">
                                    </div>
                                    <div class="col-4">
                                        <div class="form-check mt-4">
                                            <input class="form-check-input" type="checkbox" id="isGlobalOnline">
                                            <label class="form-check-label" for="isGlobalOnline">
                                                Global/Online
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="businessRegion" class="form-label">Region</label>
                                <input type="text" class="form-control" id="businessRegion">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="businessCity" class="form-label">City</label>
                                <input type="text" class="form-control" id="businessCity">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="businessOwner" class="form-label">Owner</label>
                                <input type="text" class="form-control" id="businessOwner">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Submitted By</label>
                                <div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="submittedBy" id="submittedByOwner" value="Owner">
                                        <label class="form-check-label" for="submittedByOwner">Owner</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="submittedBy" id="submittedByUser" value="User">
                                        <label class="form-check-label" for="submittedByUser">User</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="businessEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="businessEmail">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="businessPhone" class="form-label">Phone</label>
                                <input type="tel" class="form-control" id="businessPhone">
                            </div>
                            <div class="col-md-12 mb-3">
                                <label for="businessDescription" class="form-label">Description</label>
                                <div class="d-flex gap-2 mb-2">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="previewMarkdownBtn">
                                        <i class="bi bi-eye"></i> Preview Markdown
                                    </button>
                                    <a href="https://www.markdownguide.org/basic-syntax/" target="_blank" rel="noopener noreferrer" class="btn btn-outline-secondary btn-sm">
                                        <i class="bi bi-markdown"></i> Formatting Guide
                                    </a>
                                </div>
                                <textarea class="form-control" id="businessDescription" rows="5" placeholder="Describe the business. Markdown formatting is supported:&#10;&#10;**bold text**&#10;*italic text*&#10;- bullet points&#10;[link text](https://example.com)&#10;&#10;Use Markdown to make your description more readable!"></textarea>
                                <div class="form-text">
                                    <i class="bi bi-markdown"></i> Markdown formatting is supported.
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="businessLogoUrl" class="form-label">Logo URL</label>
                                <input type="url" class="form-control" id="businessLogoUrl" value="images/logos/" placeholder="images/logos/business-logo.png">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="businessLastVerified" class="form-label">Last Verified</label>
                                <input type="date" class="form-control" id="businessLastVerified">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="border-bottom pb-3 mb-3">
                                    <label class="form-label">Business Type</label>
                                    <div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="bitcoinOnlyCheckbox">
                                            <label class="form-check-label" for="bitcoinOnlyCheckbox">Bitcoin Only Business</label>
                                        </div>
                                        <div class="form-text text-muted">Check this if the business exclusively accepts Bitcoin and no other payment methods</div>
                                    </div>
                                </div>
                                
                                <label class="form-label">Payment Methods *</label>
                                <div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="onchainCheckbox">
                                        <label class="form-check-label" for="onchainCheckbox">On-chain Bitcoin</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="lightningCheckbox">
                                        <label class="form-check-label" for="lightningCheckbox">Lightning Network</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="ecashCheckbox">
                                        <label class="form-check-label" for="ecashCheckbox">eCash</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="fediCheckbox">
                                        <label class="form-check-label" for="fediCheckbox">Fedi</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="liquidCheckbox">
                                        <label class="form-check-label" for="liquidCheckbox">Liquid BTC</label>
                                    </div>
                                    <div class="validation-error" id="paymentMethodError">Please select at least one payment method</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="twitter" class="form-label">Twitter</label>
                                <input type="text" class="form-control" id="twitter" name="twitter" placeholder="@username">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="facebook" class="form-label">Facebook</label>
                                <input type="text" class="form-control" id="facebook" name="facebook" placeholder="facebook.com/username">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="instagram" class="form-label">Instagram</label>
                                <input type="text" class="form-control" id="instagram" name="instagram" placeholder="@username">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="telegram" class="form-label">Telegram</label>
                                <input type="text" class="form-control" id="telegram" name="telegram" placeholder="username">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="nostrInput" class="form-label">Nostr</label>
                                <input type="text" class="form-control" id="nostrInput">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="signalInput" class="form-label">Signal</label>
                                <input type="text" class="form-control" id="signalInput">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="mastodonInput" class="form-label">Mastodon</label>
                                <input type="text" class="form-control" id="mastodonInput">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="matrixInput" class="form-label">Matrix</label>
                                <input type="text" class="form-control" id="matrixInput">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="discordInput" class="form-label">Discord</label>
                                <input type="text" class="form-control" id="discordInput">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="keetInput" class="form-label">Keet</label>
                                <input type="text" class="form-control" id="keetInput">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="simplexInput" class="form-label">SimpleX</label>
                                <input type="text" class="form-control" id="simplexInput">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveBusinessButton">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exportModalLabel">Export JSON</h5>
                    <div>
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="confirmExportButtonTop">Export</button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="exportFileName" class="form-label">File Name</label>
                        <input type="text" class="form-control" id="exportFileName">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">JSON Preview</label>
                        <pre class="json-preview" id="jsonPreview" style="white-space: pre-wrap;"></pre>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmExportButtonTop">Export</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmDeleteModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="deleteConfirmMessage"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteButton">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Markdown Preview Modal -->
    <div class="modal fade" id="markdownPreviewModal" tabindex="-1" aria-labelledby="markdownPreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="markdownPreviewModalLabel">Description Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="markdownPreview" class="p-3 border rounded bg-light" style="min-height: 200px;">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // Global variables
        let businesses = [];
        let originalBusinesses = [];
        let currentFileName = '';
        let currentSource = '';
        let isModified = false;
        let businessModal;
        let exportModal;
        let confirmDeleteModal;
        let nostrNpubsModal;
        let currentSort = { field: null, order: 'asc' };
        let businessToDelete = null;
        
        // DOM Elements
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Bootstrap modals
            businessModal = new bootstrap.Modal(document.getElementById('businessModal'), {
                keyboard: true,
                backdrop: true,
                focus: true
            });
            exportModal = new bootstrap.Modal(document.getElementById('exportModal'));
            confirmDeleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
            nostrNpubsModal = new bootstrap.Modal(document.getElementById('nostrNpubsModal'));
            
            // Welcome screen buttons
            document.getElementById('importButton').addEventListener('click', function() {
                document.getElementById('jsonFileInput').click();
            });
            
            document.getElementById('startNewButton').addEventListener('click', startNewCollection);
            
            document.getElementById('loadFromWebsiteButton').addEventListener('click', loadDataFromWebsite);
            
            // File input change handler
            document.getElementById('jsonFileInput').addEventListener('change', handleFileUpload);
            
            // Business form submission
            document.getElementById('businessForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleBusinessFormSubmit();
            });

            // Save button in business modal
            document.getElementById('saveBusinessButton').addEventListener('click', function(e) {
                e.preventDefault();
                handleBusinessFormSubmit();
            });
            
            // Table sort handlers
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.addEventListener('click', function() {
                    const field = this.getAttribute('data-sort');
                    sortTable(field);
                });
            });
            
            // Select all checkbox
            document.getElementById('selectAllCheckbox').addEventListener('change', function() {
                const isChecked = this.checked;
                document.querySelectorAll('.business-checkbox').forEach(checkbox => {
                    checkbox.checked = isChecked;
                });
                updateBulkActionButtons();
            });
            
            // Search functionality
            document.getElementById('searchInput').addEventListener('input', filterBusinesses);
            document.getElementById('clearSearchButton').addEventListener('click', clearSearch);
            
            // Action buttons
            document.getElementById('addBusinessButton').addEventListener('click', function() {
                // Reset the form
                document.getElementById('businessForm').reset();
                document.getElementById('businessId').value = '';
                document.getElementById('selectedCategoriesList').innerHTML = '';
                document.getElementById('selectedCategoriesDisplay').style.display = 'none';
                
                // Reset validation errors
                document.querySelectorAll('.validation-error').forEach(el => el.textContent = '');
                
                // Set current date for lastVerified
                const now = new Date();
                const localDate = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
                document.getElementById('businessLastVerified').value = localDate;
                
                // Set default logo URL
                document.getElementById('businessLogoUrl').value = 'images/logos/';
                
                // Update modal title
                document.getElementById('businessModalLabel').textContent = 'Add New Business';
                
                // Show the modal
                businessModal.show();
            });
            document.getElementById('deleteSelectedButton').addEventListener('click', confirmDeleteSelected);
            document.getElementById('exportJsonButton').addEventListener('click', showExportModal);
            document.getElementById('saveChangesButton').addEventListener('click', showExportModal);
            document.getElementById('nostrNpubsButton').addEventListener('click', showNostrNpubsModal);
            document.getElementById('importNewButton').addEventListener('click', function() {
                if (isModified) {
                    if (confirm('You have unsaved changes. Are you sure you want to import a new file? Any unsaved changes will be lost.')) {
                        document.getElementById('jsonFileInput').click();
                    }
                } else {
                    document.getElementById('jsonFileInput').click();
                }
            });
            
            // Export modal
            document.getElementById('confirmExportButtonTop').addEventListener('click', exportJSON);
            
            // Delete confirmation
            document.getElementById('confirmDeleteButton').addEventListener('click', function() {
                if (Array.isArray(businessToDelete)) {
                    deleteSelectedBusinesses();
                } else {
                    deleteBusiness(businessToDelete);
                }
                confirmDeleteModal.hide();
            });
            
            // Category handling in the modal
            setupCategoryHandling();
            
            // Update selected categories display when checkbox state changes
            document.querySelectorAll('.main-category, .subcategory').forEach(checkbox => {
                checkbox.addEventListener('change', updateSelectedCategoriesDisplay);
            });
            
            // Slug generation
            document.getElementById('businessName').addEventListener('input', function() {
                if (!document.getElementById('businessSlug').value) {
                    document.getElementById('businessSlug').placeholder = generateSlug(this.value);
                }
            });
            
            document.getElementById('generateSlugButton').addEventListener('click', function() {
                const name = document.getElementById('businessName').value;
                if (name) {
                    document.getElementById('businessSlug').value = generateSlug(name);
                } else {
                    alert('Please enter a business name first.');
                }
            });
            
            // Custom category handlers
            document.getElementById('addCustomCategoryBtn').addEventListener('click', addCustomCategory);
            document.getElementById('customCategory').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addCustomCategory();
                }
            });

            // Function to populate category dropdowns
            function populateCategoryDropdowns() {
                const mainCategorySelect = document.getElementById('mainCategory');
                const subCategorySelect = document.getElementById('subCategory');
                
                // Clear existing options
                mainCategorySelect.innerHTML = '<option value="">Select Main Category</option>';
                subCategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
                
                // Add all categories to main dropdown
                Object.keys(categories).forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    mainCategorySelect.appendChild(option);
                });
                
                // Add all subcategories to subcategory dropdown
                Object.values(categories).forEach(subcategories => {
                    subcategories.forEach(subcategory => {
                        const option = document.createElement('option');
                        option.value = subcategory;
                        option.textContent = subcategory;
                        subCategorySelect.appendChild(option);
                    });
                });
            }

            // Function to handle category selection
            function handleCategorySelection() {
                const mainCategorySelect = document.getElementById('mainCategory');
                const subCategorySelect = document.getElementById('subCategory');
                const selectedMainCategory = mainCategorySelect.value;
                const selectedSubCategory = subCategorySelect.value;
                
                // Get the categories array from the form
                const categoriesArray = document.getElementById('categories').value.split(',').map(cat => cat.trim()).filter(cat => cat);
                
                // Add main category if selected
                if (selectedMainCategory && !categoriesArray.includes(selectedMainCategory)) {
                    categoriesArray.push(selectedMainCategory);
                }
                
                // Add subcategory if selected
                if (selectedSubCategory && !categoriesArray.includes(selectedSubCategory)) {
                    categoriesArray.push(selectedSubCategory);
                }
                
                // Update the categories input
                document.getElementById('categories').value = categoriesArray.join(', ');
                
                // Clear the dropdowns
                mainCategorySelect.value = '';
                subCategorySelect.value = '';
            }

            // Add event listeners for category dropdowns
            document.getElementById('mainCategory').addEventListener('change', handleCategorySelection);
            document.getElementById('subCategory').addEventListener('change', handleCategorySelection);
        });
        
        // Start a new empty collection
        function startNewCollection() {
            businesses = [];
            originalBusinesses = [];
            currentFileName = "businessData.json";
            currentSource = "New Collection";
            isModified = true;
            
            // Update UI
            updateBusinessTable();
            updateBusinessCount();
            document.getElementById('fileNameDisplay').innerHTML = 
                '<i class="bi bi-file-earmark-code"></i> ' + currentFileName + 
                ' <span class="text-muted small">(' + currentSource + ')</span>';
            
            // Show main content, hide welcome screen
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }
        
        // Handle file upload
        async function handleFileUpload(event) {
            // Get the file
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type (only accept JSON)
            if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
                alert('Please select a valid JSON file.');
                return;
            }
            
            // Show spinner
            showSpinner('Reading file...');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    
                    // Process the parsed JSON
                    if (Array.isArray(json)) {
                        processJsonData(json, file.name, 'Local File');
                    } else {
                        // If it's not an array, try to find an array property
                        let foundArray = false;
                        for (const key in json) {
                            if (Array.isArray(json[key])) {
                                processJsonData(json[key], file.name, 'Local File');
                                foundArray = true;
                                break;
                            }
                        }
                        
                        if (!foundArray) {
                            throw new Error("No valid data array found in the JSON file.");
                        }
                    }
                } catch (error) {
                    hideSpinner();
                    showError("Error parsing JSON file: " + error.message);
                    console.error(error);
                }
            };
            
            reader.onerror = function() {
                hideSpinner();
                showError("Error reading the file.");
            };
            
            reader.readAsText(file);
            
            // Reset the input to allow selecting the same file again
            event.target.value = '';
        }
        
        // Process the JSON data after loading
        function processJsonData(data, fileName, source) {
            // Normalize the data to ensure consistent structure
            businesses = data.map(normalizeBusinessData);
            
            // Keep a copy for tracking changes
            originalBusinesses = JSON.parse(JSON.stringify(businesses));
            
            // Set file name
            currentFileName = fileName || "businessData.json";
            currentSource = source || "Local File";
            isModified = false;
            
            // Update the UI
            updateBusinessTable();
            updateBusinessCount();
            document.getElementById('fileNameDisplay').innerHTML = 
                '<i class="bi bi-file-earmark-code"></i> ' + currentFileName + 
                ' <span class="text-muted small">(' + currentSource + ')</span>';
            
            // Show main content, hide welcome screen
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            
            hideSpinner();
        }
        
        // Normalize business data structure
        function normalizeBusinessData(business, index) {
            // Create a new object with all the existing properties
            const normalized = {...business};
            
            // Ensure ID exists
            if (!normalized.id) {
                normalized.id = index + 1;
            }
            
            // Ensure slug exists
            if (!normalized.slug && normalized.name) {
                normalized.slug = generateSlug(normalized.name);
            }
            
            // Ensure categories is an array
            if (!normalized.categories) {
                if (normalized.category) {
                    normalized.categories = [normalized.category];
                } else {
                    normalized.categories = [];
                }
            } else if (!Array.isArray(normalized.categories)) {
                normalized.categories = [normalized.categories];
            }
            
            // Ensure category exists for backward compatibility
            if (!normalized.category && normalized.categories && normalized.categories.length > 0) {
                normalized.category = normalized.categories[0];
            }
            
            // Ensure payment methods structure
            if (!normalized.paymentMethods) {
                normalized.paymentMethods = {
                    bitcoinOnly: false,
                    onchain: false,
                    lightning: false,
                    ecash: false,
                    fedi: false,
                    liquid: false
                };
            } else if (typeof normalized.paymentMethods !== 'object') {
                normalized.paymentMethods = {
                    bitcoinOnly: false,
                    onchain: false,
                    lightning: false,
                    ecash: false,
                    fedi: false,
                    liquid: false
                };
            }
            
            // Ensure social media structure
            if (!normalized.socialMedia) {
                normalized.socialMedia = {};
            }
            
            return normalized;
        }
        
        // Update the business table with current data
        function updateBusinessTable() {
            const tableBody = document.getElementById('businessesTableBody');
            const noBusinessesMessage = document.getElementById('noBusinessesMessage');
            
            // Clear the table
            tableBody.innerHTML = '';
            
            // If no businesses, show message and hide table
            if (businesses.length === 0) {
                noBusinessesMessage.style.display = 'block';
                return;
            }
            
            // Hide no businesses message
            noBusinessesMessage.style.display = 'none';
            
            // Add rows for each business
            businesses.forEach((business, index) => {
                const row = document.createElement('tr');
                row.className = 'business-row';
                row.dataset.id = business.id;
                
                // Add click handler for the entire row
                row.addEventListener('click', function(e) {
                    // Don't trigger row click if clicking on checkbox or action buttons
                    if (e.target.closest('.business-checkbox') || e.target.closest('.business-actions')) {
                        return;
                    }
                    editBusiness(business.id);
                });

                // Create cell for checkbox
                const checkboxCell = document.createElement('td');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'form-check-input business-checkbox';
                checkbox.dataset.id = business.id;
                checkbox.addEventListener('change', updateBulkActionButtons);
                checkboxCell.appendChild(checkbox);
                
                // Create cell for name
                const nameCell = document.createElement('td');
                
                // Add small logo image before the business name
                const logoWrapper = createBusinessLogo(business);
                nameCell.appendChild(logoWrapper);
                
                // Add the business name text
                const nameText = document.createTextNode(business.name || '');
                nameCell.appendChild(nameText);
                
                // Create cell for categories
                const categoriesCell = document.createElement('td');
                if (business.categories && business.categories.length > 0) {
                    business.categories.forEach(category => {
                        const badge = document.createElement('span');
                        badge.className = 'badge bg-secondary me-1';
                        badge.textContent = category;
                        categoriesCell.appendChild(badge);
                    });
                } else {
                    categoriesCell.textContent = 'Uncategorized';
                }
                
                // Create cell for location
                const locationCell = document.createElement('td');
                let locationText = '';
                
                // Add location information if available
                if (hasLocationInfo(business)) {
                    const locationParts = [];
                    if (business.city) locationParts.push(business.city);
                    if (business.region) locationParts.push(business.region);
                    if (business.country) locationParts.push(business.country);
                    locationText = locationParts.join(', ');
                }
                
                // Add Global/Online status if applicable
                if (business.isGlobalOrOnline) {
                    if (locationText) {
                        locationText += ' • ';
                    }
                    locationText += '<span class="text-dark">Global/Online</span>';
                } else if (!locationText) {
                    locationText = '<em>No location information available</em>';
                }
                
                locationCell.innerHTML = locationText;
                
                // Create cell for payment methods
                const paymentCell = document.createElement('td');
                if (business.paymentMethods) {
                    if (business.paymentMethods.bitcoinOnly) {
                        const badge = document.createElement('span');
                        badge.className = 'badge bg-dark me-1';
                        badge.textContent = 'Bitcoin Only';
                        paymentCell.appendChild(badge);
                    }
                    if (business.paymentMethods.onchain) {
                        const badge = document.createElement('span');
                        badge.className = 'badge bg-warning me-1';
                        badge.textContent = 'Onchain';
                        paymentCell.appendChild(badge);
                    }
                    if (business.paymentMethods.lightning) {
                        const badge = document.createElement('span');
                        badge.className = 'badge bg-primary me-1';
                        badge.textContent = 'Lightning';
                        paymentCell.appendChild(badge);
                    }
                    if (business.paymentMethods.ecash) {
                        const badge = document.createElement('span');
                        badge.className = 'badge bg-success me-1';
                        badge.textContent = 'eCash';
                        paymentCell.appendChild(badge);
                    }
                    if (business.paymentMethods.fedi) {
                        const badge = document.createElement('span');
                        badge.className = 'badge bg-info me-1';
                        badge.textContent = 'Fedi';
                        paymentCell.appendChild(badge);
                    }
                    if (business.paymentMethods.liquid) {
                        const badge = document.createElement('span');
                        badge.className = 'badge bg-secondary me-1';
                        badge.textContent = 'Liquid BTC';
                        paymentCell.appendChild(badge);
                    }
                }
                if (paymentCell.childNodes.length === 0) {
                    paymentCell.textContent = 'None specified';
                }
                
                // Create cell for last verified
                const verifiedCell = document.createElement('td');
                if (business.lastVerified) {
                    // Adjust the date to local timezone before displaying
                    const date = new Date(business.lastVerified);
                    const localDate = new Date(date.getTime() + (date.getTimezoneOffset() * 60000));
                    verifiedCell.textContent = localDate.toLocaleDateString();
                } else {
                    verifiedCell.textContent = 'Not verified';
                }
                
                // Create cell for actions
                const actionsCell = document.createElement('td');
                actionsCell.className = 'business-actions';
                
                // Edit button
                const editButton = document.createElement('button');
                editButton.className = 'btn btn-sm btn-outline-primary me-1';
                editButton.innerHTML = '<i class="bi bi-pencil"></i>';
                editButton.title = 'Edit';
                editButton.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent row click
                    editBusiness(business.id);
                });
                actionsCell.appendChild(editButton);
                
                // Delete button
                const deleteButton = document.createElement('button');
                deleteButton.className = 'btn btn-sm btn-outline-danger';
                deleteButton.innerHTML = '<i class="bi bi-trash"></i>';
                deleteButton.title = 'Delete';
                deleteButton.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent row click
                    confirmDeleteBusiness(business.id);
                });
                actionsCell.appendChild(deleteButton);
                
                // Append all cells to the row
                row.appendChild(checkboxCell);
                row.appendChild(nameCell);
                row.appendChild(categoriesCell);
                row.appendChild(locationCell);
                row.appendChild(paymentCell);
                row.appendChild(verifiedCell);
                row.appendChild(actionsCell);
                
                // Add row to table
                tableBody.appendChild(row);
            });
        }
        
        // Update the business count display
        function updateBusinessCount() {
            document.getElementById('businessCount').innerHTML = `<i class="bi bi-shop"></i> ${businesses.length} businesses`;
        }
        
        // Sort the table by the specified field
        function sortTable(field) {
            // If clicking the same field, toggle order
            if (currentSort.field === field) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                // New field, set to ascending
                currentSort.field = field;
                currentSort.order = 'asc';
            }
            
            // Sort the businesses array
            businesses.sort((a, b) => {
                let valueA, valueB;
                
                switch (field) {
                    case 'name':
                        valueA = (a.name || '').toLowerCase();
                        valueB = (b.name || '').toLowerCase();
                        break;
                    case 'location':
                        valueA = (a.country || '') + (a.region || '') + (a.city || '');
                        valueB = (b.country || '') + (b.region || '') + (b.city || '');
                        break;
                    case 'lastVerified':
                        valueA = a.lastVerified ? new Date(a.lastVerified) : new Date(0);
                        valueB = b.lastVerified ? new Date(b.lastVerified) : new Date(0);
                        break;
                    default:
                        valueA = a[field] || '';
                        valueB = b[field] || '';
                }
                
                // Compare values based on the sort order
                if (currentSort.order === 'asc') {
                    return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
                } else {
                    return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
                }
            });
            
            // Update the UI
            updateBusinessTable();
        }
        
        // Filter businesses based on search input
        function filterBusinesses() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (!searchTerm) {
                // If no search term, show all businesses
                updateBusinessTable();
                return;
            }
            
            // Filter businesses based on search term
            const filtered = businesses.filter(business => {
                // Check various fields for matches
                return (
                    (business.name && business.name.toLowerCase().includes(searchTerm)) ||
                    (business.categories && business.categories.some(cat => cat.toLowerCase().includes(searchTerm))) ||
                    (business.city && business.city.toLowerCase().includes(searchTerm)) ||
                    (business.region && business.region.toLowerCase().includes(searchTerm)) ||
                    (business.country && business.country.toLowerCase().includes(searchTerm)) ||
                    (business.owner && business.owner.toLowerCase().includes(searchTerm)) ||
                    (business.description && business.description.toLowerCase().includes(searchTerm))
                );
            });
            
            // Update table with filtered businesses
            const tableBody = document.getElementById('businessesTableBody');
            const noBusinessesMessage = document.getElementById('noBusinessesMessage');
            
            // Clear the table
            tableBody.innerHTML = '';
            
            // If no businesses match, show message
            if (filtered.length === 0) {
                noBusinessesMessage.style.display = 'block';
                noBusinessesMessage.innerHTML = `
                    <div class="text-muted">
                        <i class="bi bi-search" style="font-size: 3rem;"></i>
                        <h4 class="mt-3">No businesses match your search</h4>
                        <p>Try different search terms or clear the filter.</p>
                    </div>
                `;
                return;
            }
            
            // Hide no businesses message
            noBusinessesMessage.style.display = 'none';
            
            // Add rows for filtered businesses
            filtered.forEach(business => {
                // Find the existing row in the businesses array
                const businessIndex = businesses.findIndex(b => b.id === business.id);
                if (businessIndex !== -1) {
                    // Create a new row for this business
                    const row = document.createElement('tr');
                    row.className = 'business-row';
                    row.dataset.id = business.id;
                    
                    // Create cell for checkbox
                    const checkboxCell = document.createElement('td');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'form-check-input business-checkbox';
                    checkbox.dataset.id = business.id;
                    checkbox.addEventListener('change', updateBulkActionButtons);
                    checkboxCell.appendChild(checkbox);
                    
                    // Create cell for name
                    const nameCell = document.createElement('td');
                    
                    // Add small logo image before the business name
                    const logoWrapper = createBusinessLogo(business);
                    nameCell.appendChild(logoWrapper);
                    
                    // Add the business name text
                    const nameText = document.createTextNode(business.name || '');
                    nameCell.appendChild(nameText);
                    
                    // Create cell for categories
                    const categoriesCell = document.createElement('td');
                    if (business.categories && business.categories.length > 0) {
                        business.categories.forEach(category => {
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-secondary me-1';
                            badge.textContent = category;
                            categoriesCell.appendChild(badge);
                        });
                    } else {
                        categoriesCell.textContent = 'Uncategorized';
                    }
                    
                    // Create cell for location
                    const locationCell = document.createElement('td');
                    let locationText = '';
                    
                    // Add location information if available
                    if (hasLocationInfo(business)) {
                        const locationParts = [];
                        if (business.city) locationParts.push(business.city);
                        if (business.region) locationParts.push(business.region);
                        if (business.country) locationParts.push(business.country);
                        locationText = locationParts.join(', ');
                    }
                    
                    // Add Global/Online status if applicable
                    if (business.isGlobalOrOnline) {
                        if (locationText) {
                            locationText += ' • ';
                        }
                        locationText += '<span class="text-dark">Global/Online</span>';
                    } else if (!locationText) {
                        locationText = '<em>No location information available</em>';
                    }
                    
                    locationCell.innerHTML = locationText;
                    
                    // Create cell for payment methods
                    const paymentCell = document.createElement('td');
                    const paymentMethods = [];
                    if (business.paymentMethods) {
                        if (business.paymentMethods.bitcoinOnly) {
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-dark me-1';
                            badge.textContent = 'Bitcoin Only';
                            paymentCell.appendChild(badge);
                        }
                        if (business.paymentMethods.onchain) {
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-warning me-1';
                            badge.textContent = 'Onchain';
                            paymentCell.appendChild(badge);
                        }
                        if (business.paymentMethods.lightning) {
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-primary me-1';
                            badge.textContent = 'Lightning';
                            paymentCell.appendChild(badge);
                        }
                        if (business.paymentMethods.ecash) {
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-success me-1';
                            badge.textContent = 'eCash';
                            paymentCell.appendChild(badge);
                        }
                        if (business.paymentMethods.fedi) {
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-info me-1';
                            badge.textContent = 'Fedi';
                            paymentCell.appendChild(badge);
                        }
                        if (business.paymentMethods.liquid) {
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-secondary me-1';
                            badge.textContent = 'Liquid BTC';
                            paymentCell.appendChild(badge);
                        }
                    }
                    if (paymentCell.childNodes.length === 0) {
                        paymentCell.textContent = 'None specified';
                    }
                    
                    // Create cell for last verified
                    const verifiedCell = document.createElement('td');
                    if (business.lastVerified) {
                        const date = new Date(business.lastVerified);
                        verifiedCell.textContent = date.toLocaleDateString();
                    } else {
                        verifiedCell.textContent = 'Not verified';
                    }
                    
                    // Create cell for actions
                    const actionsCell = document.createElement('td');
                    actionsCell.className = 'business-actions';
                    
                    // Edit button
                    const editButton = document.createElement('button');
                    editButton.className = 'btn btn-sm btn-outline-primary me-1';
                    editButton.innerHTML = '<i class="bi bi-pencil"></i>';
                    editButton.title = 'Edit';
                    editButton.addEventListener('click', function() {
                        editBusiness(business.id);
                    });
                    actionsCell.appendChild(editButton);
                    
                    // Delete button
                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'btn btn-sm btn-outline-danger';
                    deleteButton.innerHTML = '<i class="bi bi-trash"></i>';
                    deleteButton.title = 'Delete';
                    deleteButton.addEventListener('click', function() {
                        confirmDeleteBusiness(business.id);
                    });
                    actionsCell.appendChild(deleteButton);
                    
                    // Append all cells to the row
                    row.appendChild(checkboxCell);
                    row.appendChild(nameCell);
                    row.appendChild(categoriesCell);
                    row.appendChild(locationCell);
                    row.appendChild(paymentCell);
                    row.appendChild(verifiedCell);
                    row.appendChild(actionsCell);
                    
                    // Add row to table
                    tableBody.appendChild(row);
                }
            });
        }
        
        // Clear the search input and reset display
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            updateBusinessTable();
        }
        
        // Update bulk action buttons based on checkbox selection
        function updateBulkActionButtons() {
            const checkboxes = document.querySelectorAll('.business-checkbox:checked');
            const bulkActionButtons = document.getElementById('bulkActionButtons');
            
            if (checkboxes.length > 0) {
                bulkActionButtons.style.display = 'block';
            } else {
                bulkActionButtons.style.display = 'none';
            }
        }
        
        // Setup category handling in the modal
        function setupCategoryHandling() {
            // Main category checkboxes
            const mainCategories = document.querySelectorAll('.main-category');
            const subcategories = document.querySelectorAll('.subcategory');
            
            // Handle main category selection/deselection
            mainCategories.forEach(mainCategory => {
                mainCategory.addEventListener('change', function() {
                    const isChecked = this.checked;
                    const categoryValue = this.value;
                    
                    // Find all subcategories that belong to this main category
                    const relatedSubcategories = document.querySelectorAll(`.subcategory[data-parent="${categoryValue}"]`);
                    
                    // Update subcategory checkboxes based on main category
                    relatedSubcategories.forEach(subcategory => {
                        if (!isChecked) {
                            subcategory.checked = false;
                        }
                    });
                    
                    // Update selected categories display
                    updateSelectedCategoriesDisplay();
                });
            });
            
            // Subcategories can be selected independently
            subcategories.forEach(subcategory => {
                subcategory.addEventListener('change', function() {
                    // Update selected categories display
                    updateSelectedCategoriesDisplay();
                });
            });
        }
        
        // Get all selected categories from the form
        function getSelectedCategories() {
            const categories = new Set();
            
            // Add main categories
            document.querySelectorAll('.main-category:checked').forEach(mainCategory => {
                categories.add(mainCategory.value);
            });
            
            // Add subcategories
            document.querySelectorAll('.subcategory:checked').forEach(subcategory => {
                categories.add(subcategory.value);
            });
            
            // Add custom categories from display
            document.querySelectorAll('#selectedCategoriesList .custom-category').forEach(badge => {
                categories.add(badge.dataset.value);
            });
            
            return Array.from(categories);
        }
        
        // Update the selected categories display
        function updateSelectedCategoriesDisplay() {
            const selectedCategories = getSelectedCategories();
            const selectedCategoriesDisplay = document.getElementById('selectedCategoriesDisplay');
            const selectedCategoriesList = document.getElementById('selectedCategoriesList');
            
            // Clear previous badges
            selectedCategoriesList.innerHTML = '';
            
            // Create a single array of all categories with their metadata
            const allCategories = selectedCategories.map(category => {
                // Check if this is a subcategory
                const subcategoryCheckbox = document.querySelector(`.subcategory[value="${category}"]`);
                if (subcategoryCheckbox) {
                    return {
                        name: category,
                        type: 'subcategory',
                        parent: subcategoryCheckbox.dataset.parent
                    };
                }
                
                // Check if it's a main category
                const mainCheckbox = document.querySelector(`.main-category[value="${category}"]`);
                if (mainCheckbox) {
                    return {
                        name: category,
                        type: 'main'
                    };
                }
                
                // If not found in checkboxes, it's a custom category
                return {
                    name: category,
                    type: 'custom'
                };
            });
            
            // Sort all categories alphabetically by name
            allCategories.sort((a, b) => a.name.localeCompare(b.name));
            
            // Create badges for all categories in alphabetical order
            allCategories.forEach(category => {
                const badge = document.createElement('span');
                badge.className = `category-badge ${category.type === 'custom' ? 'custom-category' : ''}`;
                badge.dataset.value = category.name;
                badge.dataset.type = category.type;
                if (category.type === 'subcategory') {
                    badge.dataset.parent = category.parent;
                }
                badge.innerHTML = `${category.name} <span class="remove-category" onclick="removeCategory('${category.name}')">&times;</span>`;
                selectedCategoriesList.appendChild(badge);
            });
            
            // Show/hide the container based on whether there are selected categories
            selectedCategoriesDisplay.style.display = selectedCategories.length > 0 ? 'block' : 'none';
        }
        
        // Add a custom category
        function addCustomCategory() {
            const customCategoryInput = document.getElementById('customCategory');
            const customCategory = customCategoryInput.value.trim();
            
            if (!customCategory) return;
            
            // Check if this category already exists
            const categories = getSelectedCategories();
            if (categories.includes(customCategory)) {
                alert(`Category "${customCategory}" already exists.`);
                return;
            }
            
            // Add custom category to the display
            const selectedCategoriesList = document.getElementById('selectedCategoriesList');
            const badge = document.createElement('span');
            badge.className = 'category-badge custom-category';
            badge.dataset.value = customCategory;
            badge.dataset.custom = 'true';
            badge.innerHTML = `${customCategory} <span class="remove-category" onclick="removeCategory('${customCategory}')">&times;</span>`;
            selectedCategoriesList.appendChild(badge);
            
            // Update display
            document.getElementById('selectedCategoriesDisplay').style.display = 'block';
            
            // Clear input
            customCategoryInput.value = '';
            customCategoryInput.focus();
        }
        
        // Remove a category
        function removeCategory(category) {
            // Check if it's a checkbox category
            const mainCheckbox = document.querySelector(`.main-category[value="${category}"]`);
            if (mainCheckbox) {
                mainCheckbox.checked = false;
                
                // Uncheck related subcategories
                const relatedSubcategories = document.querySelectorAll(`.subcategory[data-parent="${category}"]`);
                relatedSubcategories.forEach(subcategory => {
                    subcategory.checked = false;
                });
            }
            
            // Check if it's a subcategory
            const subCheckbox = document.querySelector(`.subcategory[value="${category}"]`);
            if (subCheckbox) {
                subCheckbox.checked = false;
            }
            
            // Remove the badge from the display
            const badges = document.querySelectorAll('#selectedCategoriesList .category-badge');
            badges.forEach(badge => {
                if (badge.dataset.value === category) {
                    badge.remove();
                }
            });
            
            // Update the display visibility
            const selectedCategoriesList = document.getElementById('selectedCategoriesList');
            if (selectedCategoriesList.children.length === 0) {
                document.getElementById('selectedCategoriesDisplay').style.display = 'none';
            }
        }
        
        // Reset category checkboxes in the form
        function resetCategoryCheckboxes() {
            // Uncheck all categories
            document.querySelectorAll('.main-category, .subcategory').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Clear custom categories
            document.getElementById('selectedCategoriesList').innerHTML = '';
            document.getElementById('selectedCategoriesDisplay').style.display = 'none';
        }
        
        // Check category checkboxes based on business data
        function setCategoryCheckboxes(categories) {
            // Reset first
            resetCategoryCheckboxes();
            
            if (!categories || !Array.isArray(categories) || categories.length === 0) {
                return;
            }
            
            // Track custom categories not found in checkboxes
            const customCategories = [];
            
            // First, enable all subcategories
            document.querySelectorAll('.subcategory').forEach(subcategory => {
                subcategory.disabled = false;
            });
            
            // Check each category
            categories.forEach(category => {
                let found = false;
                
                // Check for subcategory first
                const subcategoryCheckbox = document.querySelector(`.subcategory[value="${category}"]`);
                if (subcategoryCheckbox) {
                    subcategoryCheckbox.checked = true;
                    found = true;
                }
                
                // If not a subcategory, check for main category
                if (!found) {
                    const mainCategoryCheckbox = document.querySelector(`.main-category[value="${category}"]`);
                    if (mainCategoryCheckbox) {
                        mainCategoryCheckbox.checked = true;
                        found = true;
                    }
                }
                
                // If not found in checkboxes, it's a custom category
                if (!found) {
                    customCategories.push(category);
                }
            });
            
            // Add custom categories to display
            customCategories.forEach(category => {
                const selectedCategoriesList = document.getElementById('selectedCategoriesList');
                const badge = document.createElement('span');
                badge.className = 'category-badge custom-category';
                badge.dataset.value = category;
                badge.dataset.custom = 'true';
                badge.innerHTML = `${category} <span class="remove-category" onclick="removeCategory('${category}')">&times;</span>`;
                selectedCategoriesList.appendChild(badge);
            });
            
            // Update the display
            if (categories.length > 0) {
                document.getElementById('selectedCategoriesDisplay').style.display = 'block';
            }
        }
        
        // Generate a slug from a string (for URL-friendly identifiers)
        function generateSlug(text) {
            if (!text) return '';
            return text
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/(^-|-$)/g, '');
        }
        
        // Show add business modal
        function showAddBusinessModal() {
            // Reset the form
            document.getElementById('businessForm').reset();
            document.getElementById('businessId').value = '';
            resetCategoryCheckboxes();
            
            // Set current date for lastVerified
            const now = new Date();
            const localDate = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
            document.getElementById('businessLastVerified').value = localDate;
            
            // Update modal title
            document.getElementById('businessModalLabel').textContent = 'Add New Business';
            
            // Show the modal
            businessModal.show();
        }
        
        // Show edit business modal
        function editBusiness(businessId) {
            // Find the business
            const business = businesses.find(b => b.id == businessId);
            if (!business) {
                alert('Business not found.');
                return;
            }
            
            // Reset the form
            document.getElementById('businessForm').reset();
            
            // Set form values
            document.getElementById('businessId').value = business.id;
            document.getElementById('businessName').value = business.name || '';
            document.getElementById('businessSlug').value = business.slug || '';
            document.getElementById('businessWebsite').value = business.website || '';
            document.getElementById('businessCountry').value = business.country || '';
            document.getElementById('isGlobalOnline').checked = business.isGlobalOrOnline || false;
            document.getElementById('businessRegion').value = business.region || '';
            document.getElementById('businessCity').value = business.city || '';
            document.getElementById('businessOwner').value = business.owner || '';
            
            // Set submittedBy radio button
            const submittedByValue = business.submittedBy || 'User';
            document.querySelector(`input[name="submittedBy"][value="${submittedByValue}"]`).checked = true;
            
            document.getElementById('businessEmail').value = business.email || '';
            document.getElementById('businessPhone').value = business.phone || '';
            document.getElementById('businessDescription').value = business.description || '';
            document.getElementById('businessLogoUrl').value = business.logoUrl || 'images/logos/';
            
            // Set payment methods
            document.getElementById('bitcoinOnlyCheckbox').checked = business.paymentMethods?.bitcoinOnly || false;
            document.getElementById('onchainCheckbox').checked = business.paymentMethods?.onchain || false;
            document.getElementById('lightningCheckbox').checked = business.paymentMethods?.lightning || false;
            document.getElementById('ecashCheckbox').checked = business.paymentMethods?.ecash || false;
            document.getElementById('fediCheckbox').checked = business.paymentMethods?.fedi || false;
            document.getElementById('liquidCheckbox').checked = business.paymentMethods?.liquid || false;
            
            // Set social media
            if (business.socialMedia) {
                document.getElementById('twitter').value = business.socialMedia.twitter || '';
                document.getElementById('facebook').value = business.socialMedia.facebook || '';
                document.getElementById('instagram').value = business.socialMedia.instagram || '';
                document.getElementById('telegram').value = business.socialMedia.telegram || '';
                document.getElementById('nostrInput').value = business.socialMedia.nostr || '';
                document.getElementById('signalInput').value = business.socialMedia.signal || '';
                document.getElementById('mastodonInput').value = business.socialMedia.mastodon || '';
                document.getElementById('matrixInput').value = business.socialMedia.matrix || '';
                document.getElementById('discordInput').value = business.socialMedia.discord || '';
                document.getElementById('keetInput').value = business.socialMedia.keet || '';
                document.getElementById('simplexInput').value = business.socialMedia.simplex || '';
            }
            
            // Reset category checkboxes first
            resetCategoryCheckboxes();
            
            // Set categories
            if (business.categories && Array.isArray(business.categories)) {
                setCategoryCheckboxes(business.categories);
            }
            
            // Set last verified date
            if (business.lastVerified) {
                const date = new Date(business.lastVerified);
                // Use local date formatting instead of UTC
                const localDate = new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
                document.getElementById('businessLastVerified').value = localDate;
            } else {
                const now = new Date();
                // Use local date formatting instead of UTC
                const localDate = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
                document.getElementById('businessLastVerified').value = localDate;
            }
            
            // Update modal title
            document.getElementById('businessModalLabel').textContent = 'Edit Business';
            
            // Show the modal
            businessModal.show();
            
            // Update the selected categories display after a short delay to ensure all checkboxes are properly set
            setTimeout(updateSelectedCategoriesDisplay, 100);
        }
        
        // Handle business form submission
        function handleBusinessFormSubmit() {
            // Validate the form
            if (!validateBusinessForm()) {
                return;
            }
            
            // Get form values
            const businessId = document.getElementById('businessId').value;
            const name = document.getElementById('businessName').value;
            let slug = document.getElementById('businessSlug').value;
            
            // Generate slug if not provided
            if (!slug) {
                slug = generateSlug(name);
            }
            
            // Get categories
            const categories = getSelectedCategories();
            
            // Clean up description text
            const description = document.getElementById('businessDescription').value.trim();
            
            // Create business object
            const business = {
                name: name,
                slug: slug,
                categories: categories,
                website: document.getElementById('businessWebsite').value,
                country: document.getElementById('businessCountry').value,
                isGlobalOrOnline: document.getElementById('isGlobalOnline').checked || false,
                region: document.getElementById('businessRegion').value,
                city: document.getElementById('businessCity').value,
                owner: document.getElementById('businessOwner').value,
                submittedBy: document.querySelector('input[name="submittedBy"]:checked')?.value || 'User',
                email: document.getElementById('businessEmail').value,
                phone: document.getElementById('businessPhone').value,
                description: description,
                logoUrl: (() => {
                    const logoUrl = document.getElementById('businessLogoUrl').value;
                    // Only include logoUrl if there's content after "images/logos/"
                    if (logoUrl && logoUrl !== 'images/logos/' && logoUrl.length > 'images/logos/'.length) {
                        return logoUrl;
                    }
                    return '';
                })(),
                paymentMethods: {
                    bitcoinOnly: document.getElementById('bitcoinOnlyCheckbox').checked || false,
                    onchain: document.getElementById('onchainCheckbox').checked || false,
                    lightning: document.getElementById('lightningCheckbox').checked || false,
                    ecash: document.getElementById('ecashCheckbox').checked || false,
                    fedi: document.getElementById('fediCheckbox').checked || false,
                    liquid: document.getElementById('liquidCheckbox').checked || false
                },
                socialMedia: {
                    twitter: document.getElementById('twitter').value || null,
                    facebook: document.getElementById('facebook').value || null,
                    instagram: document.getElementById('instagram').value || null,
                    telegram: document.getElementById('telegram').value || null,
                    nostr: document.getElementById('nostrInput').value || null,
                    signal: document.getElementById('signalInput').value || null,
                    mastodon: document.getElementById('mastodonInput').value || null,
                    matrix: document.getElementById('matrixInput').value || null,
                    discord: document.getElementById('discordInput').value || null,
                    keet: document.getElementById('keetInput').value || null,
                    simplex: document.getElementById('simplexInput').value || null
                },
                // Always set lastVerified to the current date when saving
                lastVerified: new Date(new Date().getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().split('T')[0]
            };
            
            // Clean up empty social media values
            Object.keys(business.socialMedia).forEach(key => {
                if (!business.socialMedia[key]) {
                    delete business.socialMedia[key];
                }
            });
            
            // If editing an existing business
            if (businessId) {
                const index = businesses.findIndex(b => b.id == businessId);
                if (index !== -1) {
                    // Keep the existing ID
                    business.id = businesses[index].id;
                    businesses[index] = business;
                }
            } else {
                // Add new business
                // Generate a unique random ID
                business.id = generateUniqueId();
                businesses.push(business);
            }
            
            // Mark as modified
            isModified = true;
            
            // Update UI
            updateBusinessTable();
            updateBusinessCount();
            
            // Close modal
            businessModal.hide();
        }
        
        // Validate business form
        function validateBusinessForm() {
            // Reset validation errors
            document.querySelectorAll('.validation-error').forEach(el => {
                el.textContent = '';
            });
            
            let isValid = true;
            let missingFields = [];
            
            // Check name
            if (!document.getElementById('businessName').value) {
                document.getElementById('businessNameError').textContent = 'Business name is required';
                missingFields.push('Business Name');
                isValid = false;
            }
            
            // Check categories - including custom categories
            const selectedCategories = getSelectedCategories();
            if (selectedCategories.length === 0) {
                document.getElementById('categoryError').textContent = 'At least one category is required';
                missingFields.push('Categories');
                isValid = false;
            }
            
            // Check payment methods
            const bitcoinOnly = document.getElementById('bitcoinOnlyCheckbox').checked;
            const onchain = document.getElementById('onchainCheckbox').checked;
            const lightning = document.getElementById('lightningCheckbox').checked;
            const ecash = document.getElementById('ecashCheckbox').checked;
            const fedi = document.getElementById('fediCheckbox').checked;
            const liquid = document.getElementById('liquidCheckbox').checked;
            if (!bitcoinOnly && !onchain && !lightning && !ecash && !fedi && !liquid) {
                document.getElementById('paymentMethodError').textContent = 'At least one payment method is required';
                missingFields.push('Payment Methods');
                isValid = false;
            }
            
            // If there are missing fields, show an alert
            if (!isValid) {
                const message = `Please fill in the following required fields:\n${missingFields.join('\n')}`;
                alert(message);
            }
            
            return isValid;
        }
        
        // Confirm deletion of a single business
        function confirmDeleteBusiness(businessId) {
            businessToDelete = businessId;
            
            const business = businesses.find(b => b.id == businessId);
            if (business) {
                document.getElementById('deleteConfirmMessage').textContent = 
                    `Are you sure you want to delete "${business.name}"?`;
            } else {
                document.getElementById('deleteConfirmMessage').textContent = 
                    `Are you sure you want to delete this business?`;
            }
            
            confirmDeleteModal.show();
        }
        
        // Confirm deletion of multiple businesses
        function confirmDeleteSelected() {
            const selectedCheckboxes = document.querySelectorAll('.business-checkbox:checked');
            if (selectedCheckboxes.length === 0) return;
            
            businessToDelete = Array.from(selectedCheckboxes).map(checkbox => checkbox.dataset.id);
            
            document.getElementById('deleteConfirmMessage').textContent = 
                `Are you sure you want to delete ${selectedCheckboxes.length} selected businesses?`;
            
            confirmDeleteModal.show();
        }
        
        // Delete a business
        function deleteBusiness(businessId) {
            // Find index of business
            const index = businesses.findIndex(b => b.id == businessId);
            if (index !== -1) {
                // Remove from array
                businesses.splice(index, 1);
                
                // Mark as modified
                isModified = true;
                
                // Update UI
                updateBusinessTable();
                updateBusinessCount();
            }
        }
        
        // Delete selected businesses
        function deleteSelectedBusinesses() {
            const selectedIds = businessToDelete;
            if (!Array.isArray(selectedIds) || selectedIds.length === 0) return;
            
            // Remove businesses with those IDs
            businesses = businesses.filter(business => !selectedIds.includes(business.id.toString()));
            
            // Mark as modified
            isModified = true;
            
            // Update UI
            updateBusinessTable();
            updateBusinessCount();
            updateBulkActionButtons();
            
            // Uncheck "select all" checkbox
            document.getElementById('selectAllCheckbox').checked = false;
        }
        
        // Show export modal
        function showExportModal() {
            // Set file name field - strip .json extension if present for clean editing
            const baseFileName = currentFileName.replace(/\.json$/, '');
            document.getElementById('exportFileName').value = baseFileName;
            
            // Generate JSON preview
            const sortedBusinesses = [...businesses].sort((a, b) => a.id - b.id);
            const jsonString = JSON.stringify(sortedBusinesses, null, 2);
            document.getElementById('jsonPreview').textContent = jsonString;
            
            // Show modal
            exportModal.show();
        }
        
        // Export the JSON data
        function exportJSON() {
            // Get file name from modal and ensure it has .json extension
            let fileName = document.getElementById('exportFileName').value || 'businessData';
            fileName = fileName.replace(/\.json$/, ''); // Remove .json if present
            fileName = fileName + '.json'; // Add .json extension
            
            // Sort businesses by ID for consistency
            const sortedBusinesses = [...businesses].map(business => {
                // Create a copy of the business object
                const cleanedBusiness = {...business};
                
                // Clean up the description field by removing extra newlines
                if (cleanedBusiness.description) {
                    cleanedBusiness.description = cleanedBusiness.description.trim();
                }
                
                return cleanedBusiness;
            }).sort((a, b) => a.id - b.id);
            
            // Convert to JSON string with pretty formatting
            const jsonString = JSON.stringify(sortedBusinesses, null, 2);
            
            // Create download link
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            
            // Simulate click to trigger download
            document.body.appendChild(a);
            a.click();
            
            // Clean up
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Update state
            currentFileName = fileName;
            isModified = false;
            document.getElementById('fileNameDisplay').innerHTML = '<i class="bi bi-file-earmark-code"></i> ' + currentFileName;
            
            // Close modal
            exportModal.hide();
        }
        
        // Show spinner with message
        function showSpinner(message) {
            document.getElementById('spinnerMessage').textContent = message || 'Processing...';
            document.getElementById('spinnerBackdrop').style.display = 'flex';
        }
        
        // Hide spinner
        function hideSpinner() {
            document.getElementById('spinnerBackdrop').style.display = 'none';
        }
        
        // Show error in welcome screen
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            
            // Hide after 5 seconds
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }
        
        // Add global access to category removal function
        window.removeCategory = removeCategory;

        // Function to generate a unique random ID
        function generateUniqueId() {
            // Get all existing businesses
            const existingBusinesses = JSON.parse(localStorage.getItem('businesses') || '[]');
            const existingIds = existingBusinesses.map(b => b.id);
            
            // Determine the maximum range based on number of businesses
            const maxRange = existingBusinesses.length >= 1000 ? 5000 : 1000;
            
            // Generate a random ID within the determined range
            let newId;
            do {
                newId = Math.floor(Math.random() * maxRange) + 1;
            } while (existingIds.includes(newId));
            
            return newId;
        }

        // Function to check if a business has location information
        function hasLocationInfo(business) {
            return !!(business.city || business.region || business.country);
        }

        // Function to save business data
        function saveBusiness() {
            const businessName = document.getElementById('businessName').value;
            const website = document.getElementById('website').value;
            const country = document.getElementById('country').value;
            const region = document.getElementById('region').value;
            const city = document.getElementById('city').value;
            const owner = document.getElementById('owner').value;
            const businessEmail = document.getElementById('businessEmail').value;
            const phone = document.getElementById('phone').value;
            const logoUrl = document.getElementById('logoUrl').value;
            const description = document.getElementById('description').value;
            
            // Get selected categories
            const selectedCategories = [];
            document.querySelectorAll('.main-category:checked, .subcategory:checked').forEach(checkbox => {
                selectedCategories.push(checkbox.value);
            });
            
            // Get payment methods
            const bitcoinOnly = document.getElementById('bitcoinOnlyCheckbox').checked;
            const onchain = document.getElementById('onchain').checked;
            const lightning = document.getElementById('lightning').checked;
            const ecash = document.getElementById('ecash').checked;
            const fedi = document.getElementById('fedi').checked;
            const liquid = document.getElementById('liquid').checked;
            
            // Create business data object
            const businessData = {
                id: generateUniqueId(), // Use the new function to generate a unique ID
                name: businessName,
                slug: generateSlug(businessName),
                logoUrl: (() => {
                    // Only include logoUrl if there's content after "images/logos/"
                    if (logoUrl && logoUrl !== 'images/logos/' && logoUrl.length > 'images/logos/'.length) {
                        return logoUrl;
                    }
                    return '';
                })(),
                categories: selectedCategories,
                category: selectedCategories[0], // Keep first category for backward compatibility
                country: country,
                region: region,
                city: city || "",
                owner: owner || "",
                website: website,
                phone: phone || "",
                email: businessEmail || "",
                description: description || "",
                socialMedia: {
                    twitter: document.getElementById('twitter').value || null,
                    facebook: document.getElementById('facebook').value || null,
                    instagram: document.getElementById('instagram').value || null,
                    telegram: document.getElementById('telegram').value || null,
                    nostr: document.getElementById('nostrInput').value || null,
                    signal: document.getElementById('signalInput').value || null,
                    mastodon: document.getElementById('mastodonInput').value || null,
                    matrix: document.getElementById('matrixInput').value || null,
                    discord: document.getElementById('discordInput').value || null,
                    keet: document.getElementById('keetInput').value || null,
                    simplex: document.getElementById('simplexInput').value || null
                },
                paymentMethods: {
                    bitcoinOnly: bitcoinOnly,
                    onchain: onchain,
                    lightning: lightning,
                    ecash: ecash,
                    fedi: fedi,
                    liquid: liquid
                },
                lastVerified: new Date().toISOString(),
                submittedBy: "Admin"
            };
        }

        // Load data from the website
        function loadDataFromWebsite() {
            // Show spinner
            showSpinner('Loading data from website...');
            
            // Add cache-busting parameter to prevent caching
            const cacheBuster = '?v=' + new Date().getTime();
            
            fetch('https://btcaccepted.org/businessData.json' + cacheBuster)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Process the data
                    if (Array.isArray(data)) {
                        processJsonData(data, 'businessData.json', 'Downloaded from btcaccepted.org');
                    } else {
                        // If it's not an array, try to find an array property
                        let foundArray = false;
                        for (const key in data) {
                            if (Array.isArray(data[key])) {
                                processJsonData(data[key], 'businessData.json', 'Downloaded from btcaccepted.org');
                                foundArray = true;
                                break;
                            }
                        }
                        
                        if (!foundArray) {
                            throw new Error("No valid data array found in the JSON file.");
                        }
                    }
                })
                .catch(error => {
                    hideSpinner();
                    showError("Error loading data from website: " + error.message);
                    console.error(error);
                });
        }

        // Create a logo element for a business
        function createBusinessLogo(business) {
            // Create logo wrapper
            const logoWrapper = document.createElement('span');
            logoWrapper.style.display = 'inline-block';
            logoWrapper.style.marginRight = '8px';
            logoWrapper.style.width = '16px';
            logoWrapper.style.height = '16px';
            logoWrapper.style.verticalAlign = 'middle';
            
            // Create logo image
            const logoImg = document.createElement('img');
            logoImg.style.width = '100%';
            logoImg.style.height = '100%';
            logoImg.style.objectFit = 'contain';
            
            if (business.logoUrl) {
                logoImg.src = business.logoUrl;
                logoImg.alt = business.name + ' logo';
                // Handle image load error
                logoImg.onerror = function() {
                    this.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="%23dc3545"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>';
                };
            } else {
                // Default red X for no logo
                logoImg.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="%23dc3545"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>';
                logoImg.alt = 'No logo';
            }
            
            logoWrapper.appendChild(logoImg);
            return logoWrapper;
        }

        // Add this to your existing JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Markdown preview functionality
            const previewBtn = document.getElementById('previewMarkdownBtn');
            const descriptionTextarea = document.getElementById('businessDescription');
            const previewModal = new bootstrap.Modal(document.getElementById('markdownPreviewModal'));
            const previewContainer = document.getElementById('markdownPreview');

            previewBtn.addEventListener('click', function() {
                const markdownText = descriptionTextarea.value;
                if (markdownText.trim()) {
                    previewContainer.innerHTML = marked.parse(markdownText);
                } else {
                    previewContainer.innerHTML = '<em>No content to preview</em>';
                }
                previewModal.show();
            });

            // Add live preview on typing (optional, will update preview if it's open)
            descriptionTextarea.addEventListener('input', function() {
                if (document.getElementById('markdownPreviewModal').classList.contains('show')) {
                    const markdownText = this.value;
                    if (markdownText.trim()) {
                        previewContainer.innerHTML = marked.parse(markdownText);
                    } else {
                        previewContainer.innerHTML = '<em>No content to preview</em>';
                    }
                }
            });
        });

        // Show the Nostr npubs modal
        function showNostrNpubsModal() {
            populateNostrNpubsList();
            nostrNpubsModal.show();
        }

        // Track copied npubs
        let copiedNpubs = new Set();

        // Populate the Nostr npubs list
        function populateNostrNpubsList() {
            const nostrNpubsList = document.getElementById('nostrNpubsList');
            const noNostrNpubsMessage = document.getElementById('noNostrNpubsMessage');
            
            // Clear the list
            nostrNpubsList.innerHTML = '';
            
            // Find businesses with Nostr npubs
            const businessesWithNostr = businesses.filter(business => {
                return business.socialMedia && 
                       business.socialMedia.nostr && 
                       business.socialMedia.nostr.trim() !== '';
            });
            
            // If no businesses with Nostr npubs, show message
            if (businessesWithNostr.length === 0) {
                nostrNpubsList.style.display = 'none';
                noNostrNpubsMessage.style.display = 'block';
                updateNostrCounts(0, 0);
                return;
            }
            
            // Sort by lastVerified date (most recent first)
            businessesWithNostr.sort((a, b) => {
                const dateA = new Date(a.lastVerified || '1970-01-01');
                const dateB = new Date(b.lastVerified || '1970-01-01');
                return dateB - dateA;
            });
            
            // Show the list and hide the no results message
            nostrNpubsList.style.display = 'block';
            noNostrNpubsMessage.style.display = 'none';
            
            // Update counts
            updateNostrCounts(businessesWithNostr.length, businessesWithNostr);
            
            // Create list items
            businessesWithNostr.forEach((business, index) => {
                const item = document.createElement('div');
                item.className = 'nostr-npub-item';
                
                const businessName = document.createElement('div');
                businessName.className = 'nostr-business-name';
                businessName.textContent = business.name || 'Unnamed Business';
                
                const npubContainer = document.createElement('div');
                npubContainer.className = 'nostr-npub-container';
                
                const npubText = document.createElement('div');
                npubText.className = 'nostr-npub-text';
                npubText.textContent = business.socialMedia.nostr;
                
                const copyBtn = document.createElement('button');
                copyBtn.className = 'nostr-copy-btn';
                copyBtn.innerHTML = '<i class="bi bi-clipboard"></i> Copy';
                copyBtn.onclick = () => copyNostrNpub(business.socialMedia.nostr, copyBtn, copiedIndicator);
                
                const copiedIndicator = document.createElement('span');
                copiedIndicator.className = 'nostr-copied-indicator';
                copiedIndicator.innerHTML = '<i class="bi bi-check-circle-fill"></i>';
                
                // Check if this npub was already copied
                if (copiedNpubs.has(business.socialMedia.nostr)) {
                    copiedIndicator.classList.add('visible');
                }
                
                npubContainer.appendChild(npubText);
                npubContainer.appendChild(copyBtn);
                npubContainer.appendChild(copiedIndicator);
                
                const verifiedDate = document.createElement('div');
                verifiedDate.className = 'nostr-verified-date';
                if (business.lastVerified) {
                    const date = new Date(business.lastVerified);
                    verifiedDate.textContent = `Last verified: ${date.toLocaleDateString()}`;
                } else {
                    verifiedDate.textContent = 'Last verified: Unknown';
                }
                
                item.appendChild(businessName);
                item.appendChild(npubContainer);
                item.appendChild(verifiedDate);
                
                nostrNpubsList.appendChild(item);
            });
        }

        // Update Nostr counts display
        function updateNostrCounts(totalCount, businessesWithNostr = null) {
            const countBadge = document.getElementById('nostrCountBadge');
            const progressText = document.getElementById('nostrProgressText');
            
            if (totalCount === 0) {
                countBadge.textContent = '0 businesses';
                progressText.textContent = 'No npubs to copy';
                return;
            }
            
            countBadge.textContent = `${totalCount} business${totalCount === 1 ? '' : 'es'}`;
            
            if (businessesWithNostr) {
                // Count how many npubs from current list have been copied
                const copiedFromCurrentList = businessesWithNostr.filter(business => 
                    copiedNpubs.has(business.socialMedia.nostr)
                ).length;
                
                const remaining = totalCount - copiedFromCurrentList;
                
                if (remaining === 0) {
                    progressText.textContent = 'All copied! ✓';
                    progressText.className = 'badge bg-success';
                } else {
                    progressText.textContent = `${copiedFromCurrentList}/${totalCount} copied (${remaining} remaining)`;
                    progressText.className = 'badge bg-info';
                }
            }
        }

        // Copy Nostr npub to clipboard
        async function copyNostrNpub(npub, button, copiedIndicator) {
            try {
                await navigator.clipboard.writeText(npub);
                
                // Add to copied set
                copiedNpubs.add(npub);
                
                // Show the permanent check mark
                copiedIndicator.classList.add('visible');
                
                // Update counts
                updateNostrCountsAfterCopy();
                
                // Update button to show success temporarily
                const originalContent = button.innerHTML;
                button.innerHTML = '<i class="bi bi-check"></i> Copied!';
                button.classList.add('copied');
                
                // Reset button after 2 seconds
                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.classList.remove('copied');
                }, 2000);
                
            } catch (err) {
                console.error('Failed to copy npub: ', err);
                
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = npub;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                // Add to copied set
                copiedNpubs.add(npub);
                
                // Show the permanent check mark
                copiedIndicator.classList.add('visible');
                
                // Update counts
                updateNostrCountsAfterCopy();
                
                // Update button to show success temporarily
                const originalContent = button.innerHTML;
                button.innerHTML = '<i class="bi bi-check"></i> Copied!';
                button.classList.add('copied');
                
                // Reset button after 2 seconds
                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.classList.remove('copied');
                }, 2000);
            }
        }

        // Helper function to update counts after copying
        function updateNostrCountsAfterCopy() {
            // Get current businesses with Nostr npubs
            const businessesWithNostr = businesses.filter(business => {
                return business.socialMedia && 
                       business.socialMedia.nostr && 
                       business.socialMedia.nostr.trim() !== '';
            });
            
            updateNostrCounts(businessesWithNostr.length, businessesWithNostr);
        }
    </script>

    <!-- Markdown Help Modal -->
    <div class="modal fade" id="markdownHelpModal" tabindex="-1" aria-labelledby="markdownHelpModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="markdownHelpModalLabel">Markdown Formatting Guide</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6>Basic Formatting</h6>
                    <pre class="bg-light p-2 rounded">
**bold text**
*italic text*
[link text](https://example.com)
</pre>

                    <h6>Lists</h6>
                    <pre class="bg-light p-2 rounded">
- Bullet point 1
- Bullet point 2
  - Nested bullet point

1. Numbered item 1
2. Numbered item 2</pre>

                    <h6>Headers</h6>
                    <pre class="bg-light p-2 rounded">
# Large header
## Medium header
### Small header</pre>

                    <h6>Quotes</h6>
                    <pre class="bg-light p-2 rounded">
> This is a quote
> It can span multiple lines</pre>

                    <p class="mt-3 text-muted small">Use Markdown to make your business description more readable and professional.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Nostr npubs Modal -->
    <div class="modal fade" id="nostrNpubsModal" tabindex="-1" aria-labelledby="nostrNpubsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="nostrNpubsModalLabel">
                        <i class="bi bi-broadcast"></i> Nostr npubs Directory
                        <span id="nostrCountBadge" class="badge bg-secondary ms-2"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <p class="text-muted">Businesses with Nostr npubs, sorted by most recently verified:</p>
                        <div id="nostrCopyProgress" class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted small">Copy Progress:</span>
                            <span id="nostrProgressText" class="badge bg-info"></span>
                        </div>
                    </div>
                    <div id="nostrNpubsList">
                        <!-- Nostr npubs list will be populated here -->
                    </div>
                    <div id="noNostrNpubsMessage" class="text-center py-4" style="display: none;">
                        <div class="text-muted">
                            <i class="bi bi-broadcast" style="font-size: 2rem;"></i>
                            <h5 class="mt-3">No Nostr npubs found</h5>
                            <p>No businesses in the current dataset have Nostr npubs configured.</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>